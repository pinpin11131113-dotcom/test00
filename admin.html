<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Jariah æ´»å‹•ç®¡ç†å¾Œå° - æœ€çµ‚å®Œå·¥ç‰ˆ</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --main-p: #764ba2; --bg: #f0f2f5; --success: #27ae60; --match-bg: #fff5f6; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        h2 { color: var(--main-p); border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
        
        /* é…å°é …ç›®æ¨£å¼ */
        .match-item { display: flex; align-items: center; justify-content: space-between; padding: 15px; border-radius: 12px; margin-bottom: 12px; background: white; border: 1px solid #eee; }
        .mutual { border-left: 8px solid var(--success); background: #f1fcf5; } /* é›™å‘ç¶ è‰² */
        .single { border-left: 8px solid #ffa502; background: #fffaf0; } /* å–®å‘é»ƒè‰² */
        
        .pair-info { display: flex; align-items: center; gap: 10px; }
        .avatar-group { display: flex; -webkit-mask-image: linear-gradient(to right, black 70%, transparent 100%); }
        .avatar { width: 55px; height: 55px; border-radius: 50%; border: 3px solid white; object-fit: cover; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-right: -15px; }
        .names { font-size: 17px; font-weight: bold; margin-left: 20px; }
        
        .score-box { text-align: right; }
        .score-val { font-size: 22px; font-weight: bold; color: #ff4757; }
        .status-tag { font-size: 11px; padding: 4px 10px; border-radius: 20px; color: white; margin-top: 5px; display: inline-block; font-weight: bold; }

        /* è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: left; }
        th { background: var(--main-p); color: white; }
        .img-thumb-row { display: flex; gap: 5px; }
        .img-thumb { width: 45px; height: 45px; object-fit: cover; border-radius: 5px; border: 1px solid #ddd; }

        .btn { padding: 12px 25px; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-excel { background: var(--success); color: white; margin-right: 10px; }
        .btn-excel:hover { background: #219150; }
    </style>
</head>
<body>

<div class="header">
    <h1>Jariah ç²¾æº–æ´»å‹•å¾Œå°</h1>
    <div>
        <button class="btn btn-excel" onclick="exportData()">ğŸ“Š åŒ¯å‡º Excel (å«æ‰‹æ©Ÿ/é…å°)</button>
        <button class="btn" onclick="location.reload()">ğŸ”„ é‡æ–°æ•´ç†</button>
    </div>
</div>

<div class="card">
    <h2>ğŸ”¥ æœ€ä½³é…å°å»ºè­° (åˆè¨ˆæ»¿ 5 æ˜Ÿï¼Œé›™å‘èˆ‡é«˜åˆ†å„ªå…ˆ)</h2>
    <div id="full-match-list">æ­£åœ¨å¾é›²ç«¯æŠ“å–æœ€æ–°é…å°...</div>
</div>

<div class="card">
    <h2>ğŸ‘¥ åƒåŠ è€…è©³ç´°æ¸…å†Š (å«ç…§ç‰‡é è¦½èˆ‡æ‰‹æ©Ÿ)</h2>
    <table>
        <thead>
            <tr>
                <th>ç…§ç‰‡ç‰†</th>
                <th>æš±ç¨±</th>
                <th>è¯çµ¡é›»è©±</th>
                <th>è·æ¥­ / MBTI</th>
            </tr>
        </thead>
        <tbody id="user-body"></tbody>
    </table>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Firebase é…ç½®
    const cfg = { 
        apiKey: "AIzaSyDv4EOEmJ8dfWgZEv5mYtaiXuzbwgjMAUA",
        authDomain: "jariah-match.firebaseapp.com",
        projectId: "jariah-match",
        storageBucket: "jariah-match.firebasestorage.app",
        messagingSenderId: "863372390147",
        appId: "1:863372390147:web:7541b1b478c33f3d824336"
    };
    const app = initializeApp(cfg);
    const db = getFirestore(app);

    let usersMap = {};
    let excelUsers = [];

    async function initAdmin() {
        // 1. æŠ“å–æ‰€æœ‰ä½¿ç”¨è€…
        const uSnap = await getDocs(query(collection(db, "users"), orderBy("createdAt", "desc")));
        const ub = document.getElementById('user-body');
        ub.innerHTML = "";
        
        uSnap.forEach(doc => {
            const u = doc.data();
            usersMap[u.name] = u; // å»ºç«‹ç´¢å¼•ä¾›é…å°å€æŠ“ç…§ç‰‡
            
            // è™•ç†ä¸‰å¼µç…§ç‰‡ç¸®åœ–
            const imgs = u.photos ? u.photos.filter(p => p).map(p => `<img src="${p}" class="img-thumb">`).join('') : 'ğŸ‘¤';
            
            ub.innerHTML += `
                <tr>
                    <td><div class="img-thumb-row">${imgs}</div></td>
                    <td><b>${u.name}</b></td>
                    <td style="color:#d63031; font-weight:bold;">${u.phone}</td>
                    <td>${u.job} / ${u.mbti}</td>
                </tr>
            `;
            excelUsers.push({ "æš±ç¨±": u.name, "é›»è©±": u.phone, "MBTI": u.mbti, "è·æ¥­": u.job });
        });

        // 2. è™•ç†é…å°é‚è¼¯
        const mSnap = await getDocs(collection(db, "matches"));
        let pairScores = {};

        mSnap.forEach(doc => {
            const r = doc.data();
            let key = r.pair.sort().join(" â¤ï¸ "); // A-B èˆ‡ B-A è¦–ç‚ºåŒä¸€çµ„
            if (!pairScores[key]) {
                pairScores[key] = { names: r.pair, total: 0, count: 0 };
            }
            pairScores[key].total += r.score;
            pairScores[key].count += 1;
        });

        // 3. æ’åºï¼šé›™å‘(count=2)åŠ  1000 åˆ†æ’æœ€å‰ï¼Œå…¶æ¬¡çœ‹ç¸½åˆ†
        let finalSorted = Object.values(pairScores)
            .filter(m => m.total >= 5)
            .sort((a, b) => (b.count * 1000 + b.total) - (a.count * 1000 + a.total));

        const ml = document.getElementById('full-match-list');
        ml.innerHTML = finalSorted.length === 0 ? "ç›®å‰å°šç„¡åˆè¨ˆæ»¿ 5 æ˜Ÿçš„çµ„åˆã€‚" : "";

        finalSorted.forEach(m => {
            const p1 = usersMap[m.names[0]]?.photos?.[0] || '';
            const p2 = usersMap[m.names[1]]?.photos?.[0] || '';
            const isMutual = m.count === 2;

            ml.innerHTML += `
                <div class="match-item ${isMutual ? 'mutual' : 'single'}">
                    <div class="pair-info">
                        <div class="avatar-group">
                            <img src="${p1}" class="avatar">
                            <img src="${p2}" class="avatar">
                        </div>
                        <div class="names">${m.names[0]} & ${m.names[1]}</div>
                    </div>
                    <div class="score-box">
                        <div class="score-val">${m.total} â˜…</div>
                        <div class="status-tag" style="background:${isMutual ? '#27ae60' : '#ffa502'}">
                            ${isMutual ? 'ğŸ”¥ é›™å‘äº’ç›¸å¿ƒå‹•' : 'âœ¨ å–®å‘å¿ƒå‹•'}
                        </div>
                    </div>
                </div>
            `;
        });
        window.excelMatches = finalSorted.map(m => ({ "çµ„åˆ": `${m.names[0]} & ${m.names[1]}`, "åˆè¨ˆæ˜Ÿæ˜Ÿ": m.total, "ç‹€æ…‹": m.count === 2 ? 'é›™å‘' : 'å–®å‘' }));
    }

    // Excel åŒ¯å‡ºåŠŸèƒ½
    window.exportData = () => {
        if (excelUsers.length === 0) return alert("å°šç„¡è³‡æ–™");
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(excelUsers), "åƒåŠ è€…è¯çµ¡æ¸…å–®");
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(window.excelMatches || []), "é…å°å»ºè­°è¡¨");
        XLSX.writeFile(wb, "è¯èª¼æ´»å‹•æˆæœå ±å‘Š.xlsx");
    };

    initAdmin();
</script>
</body>
</html>
