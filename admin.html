<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Jariah æ´»å‹•ç®¡ç†å¾Œå° - ç²¾æº–é…å°ç‰ˆ</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f2f5; color: #333; }
        .container { max-width: 1000px; margin: auto; }
        .card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        h2 { color: #764ba2; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        /* é…å°å€æ¨£å¼ */
        .match-item { display: flex; align-items: center; justify-content: space-between; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 6px solid #ff4757; background: #fff5f6; }
        .top-match { border-left-color: #ffa502; background: #fffaf0; } /* é«˜åˆ†çµ„åˆæ¨£å¼ */
        .score-badge { background: #ff4757; color: white; padding: 5px 12px; border-radius: 20px; font-weight: bold; }
        .names { font-size: 18px; font-weight: bold; }
        
        /* è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #764ba2; color: white; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        .btn-excel { background: #27ae60; color: white; }
    </style>
</head>
<body>
<div class="container">
    <h1>Jariah ç²¾æº–é…å°å¾Œå°</h1>
    <button class="btn btn-excel" onclick="exportData()">ğŸ“Š åŒ¯å‡ºä»Šæ—¥ Excel åå†Š</button>
    <button class="btn" onclick="location.reload()">ğŸ”„ é‡æ–°æ•´ç†è³‡æ–™</button>

    <div class="card">
        <h2>ğŸ”¥ å„ªå…ˆé…å°çµ„åˆ (åˆè¨ˆæ˜Ÿæ˜Ÿæœ€é«˜)</h2>
        <div id="top-matches-list">æ­£åœ¨è¨ˆç®—æœ€ä½³çµ„åˆ...</div>
    </div>

    <div class="card">
        <h2>ğŸ“ å…¶ä»–é”æ¨™çµ„åˆå‚™è¨» (åˆè¨ˆæ»¿ 5 æ˜Ÿä»¥ä¸Š)</h2>
        <div id="other-matches-list" style="color: #666; font-size: 14px;"></div>
    </div>

    <div class="card">
        <h2>ğŸ‘¥ åƒåŠ è€…è¯çµ¡åå†Š</h2>
        <table>
            <thead><tr><th>æš±ç¨±</th><th>æ‰‹æ©Ÿ</th><th>è·æ¥­</th><th>MBTI</th></tr></thead>
            <tbody id="user-body"></tbody>
        </table>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    const cfg = { apiKey: "AIzaSyDv4EOEmJ8dfWgZEv5mYtaiXuzbwgjMAUA", authDomain: "jariah-match.firebaseapp.com", projectId: "jariah-match", storageBucket: "jariah-match.firebasestorage.app", messagingSenderId: "863372390147", appId: "1:863372390147:web:7541b1b478c33f3d824336" };
    const app = initializeApp(cfg); const db = getFirestore(app);

    async function processMatches() {
        const usersSnap = await getDocs(collection(db, "users"));
        const matchesSnap = await getDocs(collection(db, "matches"));
        
        // 1. æ•´ç†ä½¿ç”¨è€…è³‡æ–™ç”¨æ–¼ Excel
        let userData = [];
        const userBody = document.getElementById('user-body');
        usersSnap.forEach(doc => {
            const u = doc.data();
            userData.push({ "æš±ç¨±": u.name, "é›»è©±": u.phone, "MBTI": u.mbti, "è·æ¥­": u.job });
            userBody.innerHTML += `<tr><td><b>${u.name}</b></td><td>${u.phone}</td><td>${u.job}</td><td>${u.mbti}</td></tr>`;
        });
        window.allUserData = userData;

        // 2. é…å°é‚è¼¯ï¼šæ‰¾å‡ºé›™å‘è©•åˆ†ä¸¦åŠ ç¸½
        let ratings = []; // å­˜å„²æ‰€æœ‰çš„å–®å‘è©•åˆ†
        matchesSnap.forEach(doc => { ratings.push(doc.data()); });

        let pairScores = {}; // å­˜å„² A-B çµ„åˆçš„ç¸½åˆ†

        ratings.forEach(r => {
            // å°‡ A-B å’Œ B-A è¦–ç‚ºåŒä¸€å€‹çµ„åˆï¼ŒæŒ‰åå­—æ’åºç¢ºä¿ key ä¸€è‡´
            let pairKey = r.pair.sort().join(" â¤ï¸ ");
            if (!pairScores[pairKey]) {
                pairScores[pairKey] = { names: r.pair, total: 0, count: 0 };
            }
            pairScores[pairKey].total += r.score;
            pairScores[pairKey].count += 1; // è¨˜éŒ„æ˜¯å¦ç‚ºé›™å‘(2)æˆ–å–®å‘(1)
        });

        // 3. éæ¿¾ä¸¦æ’åº
        let finalMatches = Object.values(pairScores)
            .filter(m => m.total >= 5) // åªè¦åˆè¨ˆæ»¿ 5 æ˜Ÿ
            .sort((a, b) => b.total - a.total); // å¾é«˜åˆ†æ’åˆ°ä½åˆ†

        const topDiv = document.getElementById('top-matches-list');
        const otherDiv = document.getElementById('other-matches-list');
        topDiv.innerHTML = "";
        otherDiv.innerHTML = "";

        if (finalMatches.length === 0) {
            topDiv.innerHTML = "ç›®å‰å°šç„¡é”æ¨™çµ„åˆã€‚";
        }

        // 4. é¡¯ç¤ºè³‡æ–™ï¼šæœ€é«˜åˆ†æ”¾åœ¨å„ªå…ˆå€ï¼Œå…¶ä»–æ”¾å‚™è¨»
        finalMatches.forEach((m, index) => {
            const matchHtml = `
                <div class="match-item ${m.total >= 8 ? 'top-match' : ''}">
                    <div class="names">${m.names[0]} & ${m.names[1]}</div>
                    <div class="score-badge">${m.total} é¡†æ˜Ÿ ${m.count === 2 ? 'é›™å‘' : 'å–®å‘'}</div>
                </div>
            `;
            
            if (index < 5) { // å‰ 5 åæœ€é«˜åˆ†æ”¾åœ¨å„ªå…ˆå€
                topDiv.innerHTML += matchHtml;
            } else { // å…¶é¤˜æ”¾å‚™è¨»
                otherDiv.innerHTML += `â€¢ ${m.names[0]} & ${m.names[1]} (åˆè¨ˆ ${m.total} æ˜Ÿ)<br>`;
            }
        });
        
        window.matchData = finalMatches.map(m => ({ "çµ„åˆ": `${m.names[0]} & ${m.names[1]}`, "åˆè¨ˆæ˜Ÿæ˜Ÿ": m.total, "è©•åˆ†äººæ•¸": m.count }));
    }

    window.exportData = () => {
        const wb = XLSX.utils.book_new();
        // åˆ†é  1: åƒåŠ è€…æ¸…å–®
        const ws1 = XLSX.utils.json_to_sheet(window.allUserData);
        XLSX.utils.book_append_sheet(wb, ws1, "åƒåŠ è€…æ¸…å†Š");
        // åˆ†é  2: é…å°å»ºè­°
        const ws2 = XLSX.utils.json_to_sheet(window.matchData);
        XLSX.utils.book_append_sheet(wb, ws2, "é…å°å»ºè­°è¡¨");
        
        XLSX.writeFile(wb, "è¯èª¼æ´»å‹•é…å°æˆæœå ±å‘Š.xlsx");
    };

    processMatches();
</script>
</body>
</html>
