<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Jariah æ´»å‹•ç®¡ç†å¾Œå° - å…¨èƒ½åˆ†æç‰ˆ</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f2f5; }
        .card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        h2 { color: #764ba2; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        /* å¼·åŒ–å¾Œçš„é…å°é …ç›®æ¨£å¼ */
        .match-item { display: flex; align-items: center; justify-content: space-between; padding: 15px; border-radius: 12px; margin-bottom: 12px; background: white; border: 1px solid #eee; }
        .mutual { border-left: 8px solid #27ae60; background: #f1fcf5; } /* é›™å‘ç¶ è‰² */
        .single { border-left: 8px solid #ffa502; background: #fffaf0; } /* å–®å‘é»ƒè‰² */
        
        .pair-photos { display: flex; gap: 5px; align-items: center; }
        .avatar { width: 50px; height: 50px; object-ratio: 1/1; border-radius: 50%; border: 2px solid white; object-fit: cover; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .names { font-size: 16px; font-weight: bold; margin-left: 10px; }
        .score-box { text-align: right; }
        .score-num { font-size: 20px; font-weight: bold; color: #ff4757; }
        .status-tag { font-size: 11px; padding: 3px 8px; border-radius: 10px; color: white; margin-top: 5px; display: inline-block; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: left; }
    </style>
</head>
<body>
    <h1>Jariah ç²¾æº–æ´»å‹•ç›£æ§</h1>
    <button onclick="exportData()" style="background:#27ae60; color:white; padding:12px 25px; border:none; border-radius:10px; cursor:pointer; font-weight:bold;">ğŸ“Š åŒ¯å‡ºå®Œæ•´ Excel åå–®èˆ‡é…å°è¡¨</button>

    <div class="card">
        <h2>ğŸ”¥ é”æ¨™çµ„åˆæ¸…å–® (åˆè¨ˆæ»¿ 5 æ˜Ÿ)</h2>
        <div id="full-match-list">æ­£åœ¨è®€å–æœ€æ–°æ•¸æ“š...</div>
    </div>

    <div class="card">
        <h2>ğŸ‘¥ å ±åè€…è¯çµ¡æ¸…å†Š</h2>
        <table>
            <thead><tr><th>ç…§ç‰‡</th><th>æš±ç¨±</th><th>é›»è©±</th><th>è·æ¥­</th></tr></thead>
            <tbody id="user-body"></tbody>
        </table>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    const cfg = { apiKey: "AIzaSyDv4EOEmJ8dfWgZEv5mYtaiXuzbwgjMAUA", authDomain: "jariah-match.firebaseapp.com", projectId: "jariah-match", storageBucket: "jariah-match.firebasestorage.app", messagingSenderId: "863372390147", appId: "1:863372390147:web:7541b1b478c33f3d824336" };
    const app = initializeApp(cfg); const db = getFirestore(app);

    async function load() {
        const uSnap = await getDocs(collection(db, "users"));
        const mSnap = await getDocs(collection(db, "matches"));
        
        let users = {};
        const ub = document.getElementById('user-body');
        uSnap.forEach(d => {
            const u = d.data();
            users[u.name] = u; // å»ºç«‹ç´¢å¼•æ–¹ä¾¿æŠ“ç…§ç‰‡
            const p = u.photos && u.photos[0] ? `<img src="${u.photos[0]}" style="width:50px; height:50px; object-fit:cover;">` : 'ğŸ‘¤';
            ub.innerHTML += `<tr><td>${p}</td><td><b>${u.name}</b></td><td>${u.phone}</td><td>${u.job}</td></tr>`;
        });

        let pairScores = {};
        mSnap.forEach(doc => {
            const r = doc.data();
            let key = r.pair.sort().join("-");
            if (!pairScores[key]) pairScores[key] = { names: r.pair, total: 0, count: 0 };
            pairScores[key].total += r.score;
            pairScores[key].count += 1;
        });

        // æ’åºï¼šé›™å‘(count=2)å„ªå…ˆï¼Œåˆ†æ•¸é«˜å„ªå…ˆ
        let final = Object.values(pairScores)
            .filter(m => m.total >= 5)
            .sort((a, b) => (b.count * 100 + b.total) - (a.count * 100 + a.total));

        const ml = document.getElementById('full-match-list');
        ml.innerHTML = "";
        final.forEach(m => {
            const p1 = users[m.names[0]]?.photos?.[0] || '';
            const p2 = users[m.names[1]]?.photos?.[0] || '';
            const statusClass = m.count === 2 ? 'mutual' : 'single';
            const statusText = m.count === 2 ? 'é›™å‘äº’ç›¸å¿ƒå‹•' : 'å–®å‘å¿ƒå‹•';
            const tagColor = m.count === 2 ? '#27ae60' : '#ffa502';

            ml.innerHTML += `
                <div class="match-item ${statusClass}">
                    <div class="pair-photos">
                        <img src="${p1}" class="avatar"><img src="${p2}" class="avatar">
                        <div class="names">${m.names[0]} & ${m.names[1]}</div>
                    </div>
                    <div class="score-box">
                        <div class="score-num">${m.total} â˜…</div>
                        <div class="status-tag" style="background:${tagColor}">${statusText}</div>
                    </div>
                </div>
            `;
        });
        window.allEx = final.map(m => ({ "çµ„åˆ": `${m.names[0]} & ${m.names[1]}`, "åˆè¨ˆæ˜Ÿæ˜Ÿ": m.total, "ç‹€æ…‹": m.count === 2 ? 'é›™å‘' : 'å–®å‘' }));
    }
    load();
</script>
</body>
</html>
