<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Jariah æ´»å‹•ç®¡ç†å¾Œå°</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f2f5; }
        .card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        h2 { color: #764ba2; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .match-item { display: flex; align-items: center; justify-content: space-between; padding: 15px; border-radius: 12px; margin-bottom: 12px; background: white; border-left: 8px solid #ffa502; border: 1px solid #eee; }
        .mutual { border-left: 8px solid #27ae60; background: #f1fcf5; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-right: 5px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .score-num { font-size: 20px; font-weight: bold; color: #ff4757; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border: 1px solid #eee; }
        th { background: #764ba2; color: white; }
        .btn { padding: 12px 25px; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>
    <h1>æ´»å‹•ç®¡ç†å¾Œå°</h1>
    <button class="btn" style="background:#27ae60; color:white;" onclick="exportData()">ğŸ“Š åŒ¯å‡º Excel åå†Š</button>
    <button class="btn" onclick="location.reload()">ğŸ”„ é‡æ–°æ•´ç†</button>

    <div class="card">
        <h2>ğŸ”¥ é”æ¨™é…å°çµ„åˆ (åˆè¨ˆæ»¿ 5 æ˜Ÿ)</h2>
        <div id="match-list">è®€å–ä¸­...</div>
    </div>

    <div class="card">
        <h2>ğŸ‘¥ å ±åè€…è©³ç´°åå†Š</h2>
        <table>
            <thead><tr><th>ç…§ç‰‡</th><th>æš±ç¨±</th><th>é›»è©±</th><th>è·æ¥­</th></tr></thead>
            <tbody id="user-body"></tbody>
        </table>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, orderBy, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    const cfg = { apiKey: "AIzaSyDv4EOEmJ8dfWgZEv5mYtaiXuzbwgjMAUA", authDomain: "jariah-match.firebaseapp.com", projectId: "jariah-match", storageBucket: "jariah-match.firebasestorage.app", messagingSenderId: "863372390147", appId: "1:863372390147:web:7541b1b478c33f3d824336" };
    const app = initializeApp(cfg); const db = getFirestore(app);

    async function loadData() {
        const uSnap = await getDocs(query(collection(db, "users"), orderBy("createdAt", "desc")));
        const mSnap = await getDocs(collection(db, "matches"));
        let users = {}, exUsers = [];
        const ub = document.getElementById('user-body');
        uSnap.forEach(doc => {
            const u = doc.data(); users[u.name] = u;
            exUsers.push({ "æš±ç¨±": u.name, "é›»è©±": u.phone, "MBTI": u.mbti, "è·æ¥­": u.job });
            const p = u.photos && u.photos[0] ? `<img src="${u.photos[0]}" style="width:50px; height:50px; object-fit:cover;">` : 'ğŸ‘¤';
            ub.innerHTML += `<tr><td>${p}</td><td><b>${u.name}</b></td><td>${u.phone}</td><td>${u.job}</td></tr>`;
        });
        window.exUsers = exUsers;

        let pairs = {};
        mSnap.forEach(doc => {
            const r = doc.data(); let key = r.pair.sort().join("-");
            if(!pairs[key]) pairs[key] = { names: r.pair, total: 0, count: 0 };
            pairs[key].total += r.score; pairs[key].count += 1;
        });

        const ml = document.getElementById('match-list'); ml.innerHTML = "";
        const final = Object.values(pairs).filter(m => m.total >= 5).sort((a,b) => (b.count*100+b.total)-(a.count*100+a.total));
        final.forEach(m => {
            const p1 = users[m.names[0]]?.photos?.[0] || '', p2 = users[m.names[1]]?.photos?.[0] || '';
            ml.innerHTML += `<div class="match-item ${m.count===2?'mutual':''}"><div><img src="${p1}" class="avatar"><img src="${p2}" class="avatar"><b>${m.names[0]} & ${m.names[1]}</b></div><div class="score-num">${m.total} â˜…</div></div>`;
        });
        window.exMatches = final.map(m => ({ "çµ„åˆ": `${m.names[0]} & ${m.names[1]}`, "åˆè¨ˆæ˜Ÿæ•¸": m.total, "ç‹€æ…‹": m.count===2?'é›™å‘':'å–®å‘' }));
    }

    window.exportData = () => {
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(window.exUsers), "åƒåŠ è€…åå†Š");
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(window.exMatches), "é…å°çµæœ");
        XLSX.writeFile(wb, "è¯èª¼æ´»å‹•æˆæœ.xlsx");
    };
    loadData();
</script>
</body>
</html>
