<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœˆä¸‹è€äºº - æœˆéœé…’å§å°ˆå±¬ç³»çµ±</title>
    <style>
        /* --- è¦–è¦ºè¨­è¨ˆ --- */
        body { font-family: 'PingFang TC', sans-serif; background-color: #FFB74D; margin: 0; padding: 10px; color: #4E342E; }
        .container { max-width: 650px; margin: 10px auto; background-color: #FFF9F0; padding: 25px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative; }
        h1 { color: #E64A19; text-align: center; font-size: 32px; }
        h2 { border-left: 5px solid #E64A19; padding-left: 10px; color: #5D4037; font-size: 18px; margin-top: 30px; background: #FFECB3; padding: 5px; border-radius: 5px; }
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1.5px solid #FFCC80; border-radius: 12px; box-sizing: border-box; font-size: 16px; }
        textarea { min-height: 100px; resize: vertical; }
        
        /* æ¨™ç±¤è¦–è¦º */
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .tag-checkbox { display: none; }
        .tag-label { padding: 6px 12px; border: 1.5px solid #FFCC80; border-radius: 20px; background: #FFF; cursor: pointer; font-size: 12px; }
        .tag-checkbox:checked + .tag-label { background: #FF8A80; color: white; border-color: #FF8A80; }
        .tag-checkbox:disabled + .tag-label { opacity: 0.3; }

        .btn-main { width: 100%; padding: 18px; background: #E64A19; color: white; border: none; border-radius: 35px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .card { background: white; border-radius: 20px; padding: 20px; margin-top: 15px; border: 1px solid #FFCC80; text-align: left; }
        
        /* æ˜Ÿæ˜Ÿè©•åˆ† */
        .star-box { margin-top: 10px; font-size: 26px; }
        .star-btn { cursor: pointer; color: #DDD; transition: 0.3s; }
        .star-btn.active { color: gold; }

        /* å…¬å‘Šæ¬„ */
        #match-alert { background: #FFF3E0; border: 2px dashed #E64A19; border-radius: 15px; padding: 15px; margin-bottom: 20px; display: none; }
        
        /* ç®¡ç†å¾Œå°è¡¨æ ¼ */
        #admin-view { display: none; background: white; border-radius: 20px; padding: 20px; margin-top: 20px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { border: 1px solid #FFCC80; padding: 10px; text-align: center; }
        th { background: #FFECB3; }
        .match-hit { color: #E64A19; font-weight: bold; }

        .nav-btns { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .btn-nav { background: #8D6E63; color: white; border: none; padding: 8px 15px; border-radius: 15px; cursor: pointer; font-size: 12px; }
    </style>
</head>
<body>

<div class="container">
    <div class="nav-btns">
        <button class="btn-nav" onclick="logout()">åˆ‡æ›èº«ä»½/è¨»å†Š</button>
        <button class="btn-nav" onclick="toggleAdmin()" id="admin-toggle-btn">é–‹å•Ÿç®¡ç†å¾Œå°</button>
    </div>

    <h1>æœˆä¸‹è€äºº</h1>

    <div id="match-alert">
        <h3 style="margin:0 0 10px 0; font-size: 16px; color: #E64A19;">âœ¨ ç·£åˆ†é€šçŸ¥ï¼šæ‚¨èˆ‡ä¸‹åˆ—å°è±¡ç©åˆ† > 5 âœ¨</h3>
        <div id="personal-matches"></div>
    </div>

    <div id="setup-page">
        <h2>1. åŸºæœ¬ç¡¬æ€§è³‡æ–™</h2>
        <div class="input-group">
            <label>ç”Ÿæ´»ç…§ (æœ€å¤šä¸‰å¼µ)</label>
            <input type="file" accept="image/*" style="margin-bottom:5px;"><br>
            <input type="file" accept="image/*" style="margin-bottom:5px;"><br>
            <input type="file" accept="image/*">
            <p style="font-size: 11px; color: #8D6E63;">ğŸ’¡ å±•ç¾æœ€çœŸå¯¦çš„å¦³ï¼Œè®“å°æ–¹ä¸€çœ¼èªå‡ºå¦³å–”ã€‚</p>
        </div>
        <div class="input-group"><label>å¦³çš„åå­—</label><input type="text" id="uName"></div>
        <div class="input-group"><label>è‡ªæˆ‘ä»‹ç´¹ (ç½®é ‚)</label><textarea id="uBio" placeholder="å¯«ä¸‹é—œæ–¼å¦³çš„æ•…äº‹..."></textarea></div>
        <div class="input-group"><label>èº«é«˜ / æ˜Ÿåº§ / MBTI</label>
            <div style="display:flex; gap:10px;">
                <input type="number" id="uHeight" placeholder="cm">
                <select id="uHoro"><option>ç‰¡ç¾Šåº§</option><option>é‡‘ç‰›åº§</option><option>é›™å­åº§</option><option>å·¨èŸ¹åº§</option><option>ç…å­åº§</option><option>è™•å¥³åº§</option><option>å¤©ç§¤åº§</option><option>å¤©è åº§</option><option>å°„æ‰‹åº§</option><option>æ‘©ç¾¯åº§</option><option>æ°´ç“¶åº§</option><option>é›™é­šåº§</option></select>
                <select id="uMbti"><option>INTJ</option><option>ENFP</option><option>INFP</option><option>INFJ</option><option>ENTP</option><option>ENTJ</option></select>
            </div>
        </div>

        <h2>2. é¢¨æ ¼æ¨™ç±¤ (75å€‹æ¨™ç±¤ / æ¯å€é™3)</h2>
        <div id="tag-box"></div>

        <button class="btn-main" onclick="register()">å„²å­˜ä¸¦é€²å…¥æœƒå ´</button>
    </div>

    <div id="venue-page" style="display:none;">
        <h2 style="text-align: center;">æ¢ç´¢å°è±¡</h2>
        <div id="user-cards">è¼‰å…¥ä¸­...</div>
    </div>

    <div id="admin-view">
        <h2 style="margin-top:0;">ğŸ“Š æœˆéœé…’å§ï¼šå…¨å ´é…å°æ•¸æ“š</h2>
        <table id="admin-table">
            <thead>
                <tr><th>æ¸¬è©¦å“¡ A</th><th>æ¸¬è©¦å“¡ B</th><th>A çµ¦ B</th><th>B çµ¦ A</th><th>ç©åˆ†ç¸½å’Œ</th><th>ç‹€æ…‹</th></tr>
            </thead>
            <tbody id="admin-body"></tbody>
        </table>
    </div>
</div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbzGGOXqSP0_De4InUp-xBGIux_CuCAS600ACuLE-UFLzlPkPrR_3U6QGCHJKIK1dbMV/exec';

    // åˆå§‹åŒ– 75 å€‹æ¨™ç±¤
    const tagData = {
        social: ["ç†±æƒ…ä¸»å‹•", "æ…¢ç†±å…§æ–‚", "å¹½é»˜é¢¨è¶£", "å„ªè³ªå‚¾è½", "ç›´è¨€ä¸è«±", "æº«æŸ”é«”è²¼", "ç¨ç«‹è‡ªä¸»", "æ·±åº¦å°è©±", "éš¨å’Œ", "å¥½å¥‡", "æ•éŠ³", "ç©ºé–“æ„Ÿ", "ä¸»è¦‹", "å¤§æ–¹", "å¾—é«”"],
        emotion: ["æ„Ÿæ€§ç´°è†©", "å†·éœç†æ™º", "æƒ…ç·’ç©©å®š", "åŒç†å¿ƒå¼·", "ç›´è¦ºæ•éŠ³", "æ¨‚è§€ç©æ¥µ", "å…§å¹³éœ", "æƒ…æ„Ÿæ²›", "éš¨é‡è€Œå®‰", "è¬¹æ…", "å…±é³´", "è¦ºå¯Ÿ", "å¦ç‡", "è¸å¯¦", "æˆé•·"],
        value: ["äº‹æ¥­å„ªå…ˆ", "å®¶åº­é‡è¦–", "å†’éšª", "å®…å®¶", "æ¥µç°¡", "äº«æ¨‚", "è—è¡“", "å¹³æ¬Š", "ç©©å®š", "æ´»åœ¨ç•¶ä¸‹", "è‡ªç”±", "æ„›è­·å‹•ç‰©", "å„€å¼æ„Ÿ", "ä¸ç¾ˆ", "é¤Šç”Ÿ"],
        food: ["æ—¥å¼", "ç¾©å¼", "ç¾å¼", "éŸ“å¼", "ç†±ç‚’", "æ³•å¼", "ç«é‹", "è”¬é£Ÿ", "ç”œé»", "å°åƒ", "ç²¾é‡€", "æ·±å¤œé£Ÿå ‚", "é¦™æ–™", "æµ·é®®", "å’–å•¡"],
        style: ["æ­ç¾", "æ–‡é’", "æº«æŸ”", "è¡—é ­", "å¾©å¤", "æ­£å¼", "ç”œç¾", "ä¸­æ€§", "é‹å‹•", "æ³¢è¥¿ç±³äº", "é»‘è‰²ç³»", "æ…µæ‡¶", "ç¹½ç´›", "æ¥µç°¡", "å±±ç³»"]
    };

    const tBox = document.getElementById('tag-box');
    Object.keys(tagData).forEach(key => {
        tBox.innerHTML += `<h3>${key}</h3><div class="tag-container" id="${key}-tags"></div>`;
        const container = document.getElementById(`${key}-tags`);
        const limitClass = (['social','emotion','value'].includes(key)) ? 'limit-3' : '';
        tagData[key].forEach((t, i) => {
            container.innerHTML += `<input type="checkbox" id="${key}-${i}" class="tag-checkbox ${limitClass}" value="${t}"><label for="${key}-${i}" class="tag-label">${t}</label>`;
        });
    });

    // æ¨™ç±¤é™åˆ¶é‚è¼¯
    document.body.addEventListener('change', (e) => {
        if (e.target.classList.contains('limit-3')) {
            const group = e.target.parentElement;
            const checked = group.querySelectorAll('.limit-3:checked').length;
            group.querySelectorAll('.limit-3:not(:checked)').forEach(cb => cb.disabled = (checked >= 3));
        }
    });

    if(localStorage.getItem('yueLaoUser')) { showVenue(); }

    function logout() { localStorage.removeItem('yueLaoUser'); location.reload(); }

    function toggleAdmin() {
        const admin = document.getElementById('admin-view');
        admin.style.display = (admin.style.display === 'block') ? 'none' : 'block';
        document.getElementById('admin-toggle-btn').innerText = (admin.style.display === 'block') ? 'é—œé–‰ç®¡ç†å¾Œå°' : 'é–‹å•Ÿç®¡ç†å¾Œå°';
    }

    async function register() {
        const name = document.getElementById('uName').value;
        if(!name) return alert('è«‹å¡«å¯«åå­—');
        const payload = {
            action: "register",
            userName: name,
            uBio: document.getElementById('uBio').value,
            uHoro: document.getElementById('uHoro').value,
            uMbti: document.getElementById('uMbti').value
        };
        await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        localStorage.setItem('yueLaoUser', name);
        showVenue();
    }

    async function showVenue() {
        document.getElementById('setup-page').style.display = 'none';
        document.getElementById('venue-page').style.display = 'block';
        
        const res = await fetch(API_URL);
        const data = await res.json();
        const me = localStorage.getItem('yueLaoUser');

        // 1. å€‹äººé…å°é‚è¼¯ (ç©åˆ† > 5)
        const myMatches = data.matches.filter(m => m.p1 === me || m.p2 === me);
        if(myMatches.length > 0) {
            document.getElementById('match-alert').style.display = 'block';
            document.getElementById('personal-matches').innerHTML = myMatches.map(m => {
                const partner = (m.p1 === me) ? m.p2 : m.p1;
                return `<div>â¤ï¸ æ‚¨èˆ‡ <strong>${partner}</strong> ç©åˆ†é”åˆ° <strong>${m.total}</strong> åˆ†ï¼Œç·£åˆ†æ·±åšï¼</div>`;
            }).join('');
        }

        // 2. æ¸²æŸ“æœƒå ´å¡ç‰‡
        const cardBox = document.getElementById('user-cards');
        cardBox.innerHTML = '';
        data.users.forEach(u => {
            if(u.name === me) return;
            cardBox.innerHTML += `
                <div class="card">
                    <h3 style="color:#E64A19;">${u.name} - ${u.horo}</h3>
                    <p><strong>MBTI:</strong> ${u.mbti}</p>
                    <p>${u.bio}</p>
                    <div class="star-box" id="stars-${u.name}">
                        ${[1,2,3,4,5].map(i => `<span class="star-btn" onclick="rate('${u.name}', ${i})">â˜…</span>`).join('')}
                    </div>
                </div>`;
        });

        // 3. æ¸²æŸ“ç®¡ç†å¾Œå°è¡¨æ ¼
        const adminBody = document.getElementById('admin-body');
        adminBody.innerHTML = data.adminStats.map(s => `
            <tr>
                <td>${s.p1}</td><td>${s.p2}</td>
                <td>${s.s12}</td><td>${s.s21}</td>
                <td>${s.total}</td>
                <td class="${s.total > 5 ? 'match-hit' : ''}">${s.total > 5 ? 'âœ… é…å°æˆåŠŸ' : 'å°šæœªå¥‘åˆ'}</td>
            </tr>
        `).join('');
    }

    async function rate(toUser, score) {
        const fromUser = localStorage.getItem('yueLaoUser');
        const starRow = document.getElementById(`stars-${toUser}`);
        Array.from(starRow.children).forEach((s, i) => s.classList.toggle('active', i < score));
        
        await fetch(API_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ action: "rate", fromUser, toUser, stars: score })
        });
        alert(`å·²çµ¦äºˆ ${toUser} ${score} é¡†æ˜Ÿï¼ç³»çµ±æ­£åœ¨é‡æ–°è¨ˆç®—å¥‘åˆåº¦...`);
        showVenue();
    }
</script>
</body>
</html>
