<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœˆä¸‹è€äºº - æœˆéœé…’å§</title>

    <style>
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background-color: #FFB74D; margin: 0; padding: 10px; color: #4E342E; }
        .container { max-width: 650px; margin: 10px auto; background-color: #FFF9F0; padding: 25px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative; min-height: 80vh; }
        .logout-btn { position: absolute; top: 20px; right: 20px; background: #8D6E63; color: white; border: none; padding: 8px 15px; border-radius: 15px; cursor: pointer; font-size: 13px; z-index: 10; }
        h1 { color: #E64A19; text-align: center; font-size: 32px; margin-bottom: 5px; }
        h2 { border-left: 5px solid #E64A19; padding-left: 10px; color: #5D4037; font-size: 20px; margin-top: 35px; background: #FFECB3; padding: 5px; border-radius: 5px; }
        
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 12px; border: 1.5px solid #FFCC80; border-radius: 12px; box-sizing: border-box; font-size: 16px; background: white; }
        textarea { min-height: 120px; }

        /* æ¨™ç±¤é¸å–®æ¨£å¼ */
        .tag-block { margin-bottom: 20px; }
        .tag-category-header { font-size: 15px; color: #E64A19; font-weight:bold; margin-bottom: 8px; border-bottom: 1px dashed #FFCC80; padding-bottom: 5px; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag-checkbox { display: none; }
        .tag-label { display: inline-block; padding: 8px 16px; border: 1.5px solid #FFCC80; border-radius: 20px; background: #FFF; color: #5D4037; cursor: pointer; font-size: 13px; transition: 0.2s; user-select: none; }
        .tag-checkbox:checked + .tag-label { background: #FF8A80; color: white; border-color: #FF8A80; font-weight: bold; transform: scale(1.05); }
        .tag-checkbox:disabled + .tag-label { opacity: 0.4; cursor: not-allowed; background: #EEE; }

        .btn-main { width: 100%; padding: 18px; background: #E64A19; color: white; border: none; border-radius: 35px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; }

        /* å¡ç‰‡èˆ‡é…å°é é¢æ¨£å¼ */
        #venue-page { position: relative; min-height: 600px; display: none; }
        .card-stack { position: relative; width: 100%; max-width: 500px; margin: 0 auto; }
        .card { background: white; border-radius: 20px; padding: 0; border: 1px solid #FFCC80; text-align: left; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin: 0 auto; overflow: hidden; }
        
        .card-header-area { background: linear-gradient(135deg, #FFF3E0, #FFE0B2); padding: 20px; border-bottom: 1px solid #FFCC80; }
        .card-name { font-size: 28px; font-weight: bold; color: #E64A19; margin: 0; }
        .card-mbti { display: inline-block; background: #FF8A80; color: white; padding: 3px 10px; border-radius: 15px; font-size: 14px; font-weight: bold; margin-left: 10px; vertical-align: middle; }
        
        .photo-scroll { display: flex; overflow-x: auto; padding: 10px; gap: 10px; background: #FAFAFA; scroll-behavior: smooth; }
        .photo-item { flex: 0 0 85%; aspect-ratio: 1/1; object-fit: cover; border-radius: 15px; border: 1px solid #DDD; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .no-photo { flex: 0 0 100%; height: 200px; display: flex; align-items: center; justify-content: center; background: #EEE; color: #999; border-radius: 15px; font-weight:bold; }

        .card-body { padding: 20px; }
        .section-title { font-size: 18px; font-weight: bold; color: #5D4037; margin-top: 25px; margin-bottom: 12px; border-left: 5px solid #E64A19; padding-left: 10px; background: #FFF8E1; padding-top: 8px; padding-bottom: 8px; border-radius: 0 10px 10px 0; }
        .bio-text { font-size: 16px; color: #333; line-height: 1.6; white-space: pre-wrap; margin-bottom: 15px; background: #FAFAFA; padding: 15px; border-radius: 10px; border: 1px dashed #DDD; }
        
        .info-row { display: flex; margin-bottom: 10px; border-bottom: 1px dashed #EEE; padding-bottom: 8px; font-size: 15px; align-items: baseline; }
        .info-label { width: 90px; font-weight: bold; color: #E64A19; flex-shrink: 0; }
        .info-value { color: #333; flex-grow: 1; word-break: break-word; }

        /* æ¨™ç±¤é¡¯ç¤ºæ¨£å¼ */
        .tag-display-group { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; }
        .tag-badge { font-size: 13px; padding: 6px 12px; border-radius: 15px; color: white; display: inline-block; box-shadow: 1px 1px 3px rgba(0,0,0,0.1); }
        .tag-social { background: #FFB74D; }
        .tag-emotion { background: #90A4AE; }
        .tag-value { background: #81C784; }
        .tag-food { background: #FF8A65; }
        .tag-style { background: #BA68C8; }
        .tag-empty { color: #999; font-style: italic; font-size: 13px; padding: 5px; }

        .action-area { padding: 20px; background: #FFF3E0; display: flex; flex-direction: column; align-items: center; gap: 15px; border-top: 1px solid #FFCC80; }
        .star-box { font-size: 36px; display: flex; gap: 15px; }
        .star-btn { cursor: pointer; transition: 0.2s; transform: scale(1); filter: grayscale(100%); opacity: 0.5; }
        .star-btn:hover, .star-btn:active { transform: scale(1.2); filter: grayscale(0%); opacity: 1; }
        .skip-btn { background: #CFD8DC; color: #546E7A; border: none; padding: 12px 40px; border-radius: 30px; cursor: pointer; font-weight: bold; font-size: 14px; width: 100%; }

        #match-notification { display: none; background: #FFF3E0; border: 3px dashed #E64A19; border-radius: 15px; padding: 20px; text-align: center; margin-bottom: 20px; }
        #fallback-box { text-align: center; display: none; margin-top: 50px; padding: 30px; background: #FFF3E0; border-radius: 20px; }
        #fallback-box img { width: 180px; border-radius: 50%; border: 4px solid #E64A19; margin-bottom: 15px; }
        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); color: white; text-align: center; padding-top: 200px; z-index: 1000; font-weight: bold; font-size: 18px; }
    </style>
</head>
<body>

<div id="loading-overlay">è¼‰å…¥ä¸­...</div>

<div class="container">
    <button class="logout-btn" onclick="logout()">åˆ‡æ›èº«ä»½</button>
    <h1>æœˆä¸‹è€äºº</h1>

    <div id="setup-page">
        <h2>1. éˆé­‚è‡ªæˆ‘ä»‹ç´¹ (ç½®é ‚)</h2>
        <div class="input-group"><label>è‡ªæˆ‘ä»‹ç´¹</label><textarea id="uBio" placeholder="é—œæ–¼å¦³çš„æ•…äº‹..."></textarea></div>
        <div class="input-group">
            <label>ç”Ÿæ´»ç…§ (é¸ä¸‰å¼µ)</label>
            <input type="file" id="file1" accept="image/*" style="margin-bottom:5px;">
            <input type="file" id="file2" accept="image/*" style="margin-bottom:5px;">
            <input type="file" id="file3" accept="image/*">
        </div>
        <div class="input-group"><label>å¦³çš„åå­—</label><input type="text" id="uName"></div>
        <div class="input-group"><label>åŸºæœ¬è³‡æ–™</label>
            <div style="display:flex; gap:10px;"><input type="date" id="uBirth" style="flex:1;"><input type="number" id="uHeight" placeholder="cm" style="flex:1;"></div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <select id="uHoro"><option>ç‰¡ç¾Šåº§</option><option>é‡‘ç‰›åº§</option><option>é›™å­åº§</option><option>å·¨èŸ¹åº§</option><option>ç…å­åº§</option><option>è™•å¥³åº§</option><option>å¤©ç§¤åº§</option><option>å¤©è åº§</option><option>å°„æ‰‹åº§</option><option>æ‘©ç¾¯åº§</option><option>æ°´ç“¶åº§</option><option>é›™é­šåº§</option></select>
                <select id="uMbti">
                    <option value="">MBTI</option>
                    <option>ä¸çŸ¥é“ / é‚„åœ¨æ¢ç´¢</option>
                    <optgroup label="åˆ†æå®¶"><option>INTJ å»ºç¯‰å¸«</option><option>INTP é‚è¼¯å­¸å®¶</option><option>ENTJ æŒ‡æ®å®˜</option><option>ENTP è¾¯è«–å®¶</option></optgroup>
                    <optgroup label="å¤–äº¤å®˜"><option>INFJ æå€¡è€…</option><option>INFP èª¿è§£è€…</option><option>ENFJ ä¸»äººå…¬</option><option>ENFP ç«¶é¸è€…</option></optgroup>
                    <optgroup label="å®ˆè­·è€…"><option>ISTJ ç‰©æµå¸«</option><option>ISFJ å®ˆè¡›è€…</option><option>ESTJ ç¸½ç®¡</option><option>ESFJ åŸ·æ”¿å®˜</option></optgroup>
                    <optgroup label="æ¢éšªå®¶"><option>ISTP é‘’è³å®¶</option><option>ISFP æ¢éšªå®¶</option><option>ESTP ä¼æ¥­å®¶</option><option>ESFP è¡¨æ¼”è€…</option></optgroup>
                </select>
            </div>
        </div>
        <div class="input-group">
            <label>èº«ä»½</label>
            <select id="uGender"><option>å¥³æ€§</option><option>è·¨å¥³</option><option>éäºŒå…ƒ</option><option>æ¢ç´¢ä¸­</option></select>
            <select id="uSex" style="margin-top:5px;"><option>å¥³åŒå¿—</option><option>é›™æ€§æˆ€</option><option>ç•°æ€§æˆ€</option><option>æ³›æ€§æˆ€</option><option>ç„¡æ€§æˆ€</option></select>
            <select id="uStatus" style="margin-top:5px;">
                <option>å–®èº«</option>
                <option>é–‹æ”¾å¼é—œä¿‚</option>
                <option>æ›–æ˜§ä¸­</option>
                <option>å°‹æ‰¾ç©©å®šé—œä¿‚</option>
            </select>
        </div>

        <h2>2. å€‹æ€§èˆ‡æœŸå¾…</h2>
        <div class="input-group">
            <label>ç ´å†°å•é¡Œ</label>
            <select id="uIceQ" style="margin-bottom:8px;"><option>å¦‚æœä¸è€ƒæ…®é‡‘éŒ¢ï¼Œå¦³æœ€æƒ³å»å“ªè£¡ç”Ÿæ´»ï¼Ÿ</option><option>å¦‚æœæ˜å¤©æ˜¯ä¸–ç•Œæœ«æ—¥ï¼Œå¦³æœ€å¾Œä¸€é¤æƒ³åƒä»€éº¼ï¼Ÿ</option><option>å¦³ç†æƒ³ä¸­çš„å®Œç¾é€±æœ«æ˜¯æ€éº¼éçš„ï¼Ÿ</option></select>
            <textarea id="uIceA" placeholder="å¯«ä¸‹å¦³çš„å›ç­”..." style="min-height:80px;"></textarea>
        </div>
        <div class="input-group">
            <label>é—œæ–¼å¯µç‰©</label>
            <select id="uPet"><option>è²“æ´¾</option><option>ç‹—æ´¾</option><option>éƒ½æœ‰ / éƒ½å–œæ­¡</option><option>éƒ½æ²’æœ‰ä½†å–œæ­¡</option><option>éæ•ä¸­ / ä¸å¤ªè¦ªè¿‘</option></select>
        </div>
        <div class="input-group"><label>ç´„æœƒæœŸå¾…</label><select id="uDate"><option>å®‰éœå–å’–å•¡</option><option>å»çœ‹å±•è¦½</option><option>é…’ç²¾è·¯è·‘</option><option>çœ‹å¤œæ™¯</option><option>æ¼«æ­¥å…¬åœ’</option><option>éŠæ¨‚åœ’å†’éšª</option><option>æ‰‹ä½œå·¥ä½œåŠ</option><option>é›»å½±é¦¬æ‹‰æ¾</option><option>ç²¾ç·»æ³•é¤</option><option>å¯†å®¤é€ƒè„«</option></select></div>

        <h2>3. èˆˆè¶£</h2>
        <div class="input-group"><label>å–œæ­¡çš„é›»å½±</label><input type="text" id="uMovie" placeholder="ç‹å®¶è¡›..."></div>
        <div class="input-group"><label>å–œæ­¡çš„éŸ³æ¨‚</label><input type="text" id="uMusic" placeholder="ç¨ç«‹æ¨‚åœ˜..."></div>
        <div class="input-group"><label>å–œæ­¡çš„é‹å‹•</label><input type="text" id="uSport" placeholder="çˆ¬å±±..."></div>
        <div class="input-group"><label>å…¶ä»–èˆˆè¶£ç´°ç¯€</label><textarea id="uHobby" placeholder="é‚„æœ‰ä»€éº¼ï¼Ÿ"></textarea></div>

        <h2>4. æ¨™ç±¤ (å„å€é™é¸3å€‹)</h2>
        <div id="tag-box-container"></div>

        <button class="btn-main" onclick="register()">å„²å­˜ä¸¦é€²å…¥æœƒå ´</button>
    </div>

    <div id="venue-page">
        <div id="match-notification"></div>
        <div class="card-stack" id="single-card-container"></div>
        <div id="fallback-box">
            <img src="staff_old_man.jpg">
            <p style="color:#E64A19; font-weight:bold;">ç·£åˆ†å¾®é†ºä¸­...</p>
            <button class="btn-main" style="background:#8D6E63;" onclick="location.reload()">é‡æ–°æ•´ç†</button>
        </div>
    </div>
</div>

<script>
    /* ğŸ”¥ã€é—œéµä¿®å¾©ã€‘: æ¨™ç±¤ç”¢ç”Ÿç¨‹å¼ç¢¼ç§»åˆ°æœ€ä¸Šé¢ï¼Œä¿è­‰ä¸€é€²ä¾†å°±çœ‹å¾—åˆ° */
    (function initTags() {
        const tagData = {
            social: ["ç†±æƒ…ä¸»å‹•", "æ…¢ç†±å…§æ–‚", "å¹½é»˜é¢¨è¶£", "å„ªè³ªå‚¾è½", "ç›´è¨€ä¸è«±", "æº«æŸ”é«”è²¼", "ç¨ç«‹è‡ªä¸»", "æ·±åº¦å°è©±", "éš¨å’Œéš¨èˆˆ", "å¥½å¥‡å¿ƒå¼·", "è§€å¯Ÿæ•éŠ³", "çµ¦äºˆç©ºé–“", "æœ‰ä¸»è¦‹", "ä¸æ‹˜å°ç¯€", "å„ªé›…å¾—é«”"],
            emotion: ["æ„Ÿæ€§ç´°è†©", "å†·éœç†æ™º", "æƒ…ç·’ç©©å®š", "åŒç†å¿ƒå¼·", "ç›´è¦ºæ•éŠ³", "æ¨‚è§€ç©æ¥µ", "å…§æ–‚å¹³éœ", "æƒ…æ„Ÿå……æ²›", "éš¨é‡è€Œå®‰", "è¬¹æ…é˜²å‚™", "æ¸´æœ›å…±é³´", "è‡ªæˆ‘è¦ºå¯Ÿ", "å¦ç‡å¤§æ–¹", "å®‰ç©©è¸å¯¦", "è¿½æ±‚æˆé•·"],
            value: ["äº‹æ¥­å„ªå…ˆ", "é‡è¦–å®¶åº­", "æˆ¶å¤–å†’éšª", "å®…åœ¨å®¶ä¸­", "æ¥µç°¡ä¸»ç¾©", "äº«æ¨‚ç”Ÿæ´»", "è—è¡“å“å‘³", "æ€§åˆ¥å¹³æ¬Š", "ç©©å®šå®‰é€¸", "æ´»åœ¨ç•¶ä¸‹", "è²¡å‹™è‡ªç”±", "æ„›è­·å‹•ç‰©", "å„€å¼æ„Ÿ", "è‡ªç”±ä¸ç¾ˆ", "å¥åº·é¤Šç”Ÿ"],
            food: ["æ—¥å¼", "ç¾©å¼", "ç¾å¼", "éŸ“å¼", "å°å¼ç†±ç‚’", "æ³•å¼", "ç«é‹", "è”¬é£Ÿ", "ç”œé»", "å°åƒ", "ç²¾é‡€å•¤é…’", "æ·±å¤œé£Ÿå ‚", "ç•°åœ‹é¦™æ–™", "æµ·é®®", "å’–å•¡"],
            style: ["æ­ç¾", "æ—¥ç³»æ–‡é’", "éŸ“ç³»æº«æŸ”", "è¡—é ­", "å¾©å¤", "æ­£å¼", "ç”œç¾", "ä¸­æ€§å¸¥æ°£", "é‹å‹•", "æ³¢è¥¿ç±³äº", "é»‘è‰²ç³»", "æ…µæ‡¶", "ç¹½ç´›", "æ¥µç°¡", "å±±ç³»"]
        };

        const titles = { social: 'ç¤¾äº¤', emotion: 'æƒ…ç·’', value: 'åƒ¹å€¼è§€', food: 'ç¾é£Ÿ', style: 'é¢¨æ ¼' };
        const container = document.getElementById('tag-box-container');
        
        if (container) {
            container.innerHTML = '';
            Object.keys(tagData).forEach(key => {
                let html = `<div class="tag-block"><div class="tag-category-header">${titles[key]}</div><div class="tag-container" id="${key}-tags">`;
                const limitClass = (['social','emotion','value'].includes(key)) ? 'limit-3' : '';
                
                tagData[key].forEach((t, i) => {
                    const uid = `${key}-${i}`;
                    html += `<input type="checkbox" id="${uid}" class="tag-checkbox ${limitClass}" value="${t}">
                             <label for="${uid}" class="tag-label">${t}</label>`;
                });
                html += `</div></div>`;
                container.innerHTML += html;
            });
        }
    })();

    // ç›£è½é¸å–é™åˆ¶ (æœ€å¤š3å€‹)
    document.body.addEventListener('change', (e) => {
        if (e.target.classList.contains('limit-3')) {
            const group = e.target.parentElement;
            const checked = group.querySelectorAll('.limit-3:checked').length;
            group.querySelectorAll('.limit-3:not(:checked)').forEach(cb => cb.disabled = (checked >= 3));
        }
    });

    // ----------------------------------------------------------------
    // ç³»çµ±é‚è¼¯å€ (é€™éƒ¨åˆ†å¦‚æœæœ‰éŒ¯ï¼Œä¹Ÿä¸æœƒå½±éŸ¿ä¸Šé¢æ¨™ç±¤çš„é¡¯ç¤º)
    // ----------------------------------------------------------------

    // âš ï¸ è«‹å¡«å…¥æ‚¨çš„ Apps Script ç¶²å€
    const API_URL = 'https://script.google.com/macros/s/AKfycbzGGOXqSP0_De4InUp-xBGIux_CuCAS600ACuLE-UFLzlPkPrR_3U6QGCHJKIK1dbMV/exec';

    const firebaseConfig = {
        apiKey: "AIzaSyDv4EOEmJ8dFwgZEv5mYtaiXuzbwgjMAUA",
        authDomain: "jariah-match.firebaseapp.com",
        projectId: "jariah-match",
        appId: "1:863372390147:web:7541b1b478c33f3d824336"
    };

    // å®‰å…¨è¼‰å…¥ Firebase
    try {
        const script = document.createElement('script');
        script.src = "https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js";
        script.onload = () => {
            try { firebase.initializeApp(firebaseConfig); } catch(e) {}
            document.getElementById('loading-overlay').style.display = 'none';
            if(localStorage.getItem('yueLaoUser')) showVenue();
        };
        document.head.appendChild(script);
    } catch(e) { console.log("Firebase error", e); }

    function logout() { if(confirm('ç¢ºå®šè¦åˆ‡æ›èº«ä»½å—ï¼Ÿ')) { localStorage.removeItem('yueLaoUser'); location.reload(); } }

    // åœ–ç‰‡è½‰æ–‡å­—
    function compressImage(file) {
        return new Promise((resolve) => {
            if (!file) { resolve(""); return; }
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX = 300; 
                    let w = img.width, h = img.height;
                    if (w > h) { if (w > MAX) { h *= MAX/w; w = MAX; } } else { if (h > MAX) { w *= MAX/h; h = MAX; } }
                    canvas.width = w; canvas.height = h;
                    ctx.drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.6));
                };
            };
        });
    }

    async function register() {
        const name = document.getElementById('uName').value;
        if(!name) return alert('è«‹å¡«å¯«åå­—');
        
        const overlay = document.getElementById('loading-overlay');
        overlay.style.display = 'block';
        overlay.innerText = "è³‡æ–™å„²å­˜ä¸­...";

        try {
            const p1 = await compressImage(document.getElementById('file1').files[0]);
            const p2 = await compressImage(document.getElementById('file2').files[0]);
            const p3 = await compressImage(document.getElementById('file3').files[0]);

            const getTags = (id) => Array.from(document.querySelectorAll(`#${id}-tags input:checked`)).map(el => el.value).join(',');

            const payload = {
                action: "register",
                uName: name, p1: p1, p2: p2, p3: p3,
                uBio: document.getElementById('uBio').value, uBirth: document.getElementById('uBirth').value, uHeight: document.getElementById('uHeight').value, uHoro: document.getElementById('uHoro').value, uMbti: document.getElementById('uMbti').value, 
                uGender: document.getElementById('uGender').value, uSex: document.getElementById('uSex').value, uStatus: document.getElementById('uStatus').value,
                uIceA: `[${document.getElementById('uIceQ').value}] ${document.getElementById('uIceA').value}`, 
                uPet: document.getElementById('uPet').value, uDate: document.getElementById('uDate').value,
                uMovie: document.getElementById('uMovie').value, uMusic: document.getElementById('uMusic').value, uSport: document.getElementById('uSport').value, uHobby: document.getElementById('uHobby').value,
                tagSocial: getTags('social'), tagEmotion: getTags('emotion'), tagValue: getTags('value'), tagFood: getTags('food'), tagStyle: getTags('style')
            };

            await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            localStorage.setItem('yueLaoUser', name);
            showVenue();
        } catch(e) {
            overlay.style.display = 'none';
            alert("ç™¼ç”ŸéŒ¯èª¤ï¼š" + e.message);
        }
    }

    let venueData = [];
    let currentIndex = 0;

    async function showVenue() {
        const overlay = document.getElementById('loading-overlay');
        overlay.style.display = 'block';
        overlay.innerText = "é€²å…¥æœƒå ´ä¸­...";
        
        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            const me = localStorage.getItem('yueLaoUser');
            
            overlay.style.display = 'none';
            document.getElementById('setup-page').style.display = 'none';
            document.getElementById('venue-page').style.display = 'block';
            window.scrollTo(0,0);

            const myMatches = data.adminStats.filter(s => (s.p1 === me || s.p2 === me) && s.isMatch);
            const matchBox = document.getElementById('match-notification');
            if(myMatches.length > 0) {
                matchBox.style.display = 'block';
                matchBox.innerHTML = `<h3 style="margin:0;color:#E64A19;">ğŸ’– é…å°æˆåŠŸï¼</h3>` + myMatches.map(m => `<div style="font-weight:bold;margin-top:5px;">âœ¨ èˆ‡ ${(m.p1 === me) ? m.p2 : m.p1} é»˜å¥‘ ${m.total} åˆ†</div>`).join('');
            } else { matchBox.style.display = 'none'; }

            const ratedList = data.ratedHistory || {};
            venueData = data.users.filter(u => u.name !== me && !ratedList[me + "_" + u.name]);
            currentIndex = 0;
            renderCurrentCard();
        } catch(e) { 
            overlay.style.display = 'none'; 
            document.getElementById('setup-page').style.display = 'none';
            document.getElementById('venue-page').style.display = 'block';
            alert("ç›®å‰æ²’æœ‰å…¶ä»–è³‡æ–™ï¼Œæˆ–ç¶²è·¯ä¸ç©©ã€‚");
        }
    }

    function renderCurrentCard() {
        const container = document.getElementById('single-card-container');
        if (currentIndex >= venueData.length) { container.innerHTML = ''; document.getElementById('fallback-box').style.display = 'block'; return; }
        document.getElementById('fallback-box').style.display = 'none';
        
        const u = venueData[currentIndex];
        
        const renderImg = (src) => src ? `<img src="${src}" class="photo-item">` : '';
        const photosHtml = (u.p1 || u.p2 || u.p3) ? [u.p1, u.p2, u.p3].map(renderImg).join('') : '<div class="no-photo">ç„¡ç…§ç‰‡</div>';

        const renderTags = (str, cls) => {
            if (!str || str === 'undefined' || str === '') return '<span class="tag-empty">(æ­¤äººæœªé¸æ“‡)</span>';
            return str.split(',').map(t => `<span class="tag-badge ${cls}">${t}</span>`).join('');
        };

        container.innerHTML = `
            <div class="card">
                <div class="card-header-area">
                    <span class="card-name">${u.name}</span>
                    <span class="card-mbti">${u.mbti}</span>
                    <div style="margin-top:5px; font-size:14px; color:#795548;">
                        ${u.horo} / ${u.birth} / ${u.height}cm
                    </div>
                </div>
                <div class="photo-scroll">${photosHtml}</div>
                <div class="card-body">
                    <div class="bio-text">${u.bio || "é€™å€‹äººå¾ˆç¥ç§˜ï¼Œé‚„æ²’å¯«è‡ªæˆ‘ä»‹ç´¹..."}</div>
                    <div class="section-title">åŸºæœ¬æª”æ¡ˆ</div>
                    <div class="info-row"><div class="info-label">èº«ä»½</div><div class="info-value">${u.gender}</div></div>
                    <div class="info-row"><div class="info-label">æ€§å–å‘</div><div class="info-value">${u.sex}</div></div>
                    <div class="info-row"><div class="info-label">æ„Ÿæƒ…ç‹€æ…‹</div><div class="info-value">${u.status}</div></div>
                    <div class="info-row"><div class="info-label">é—œæ–¼å¯µç‰©</div><div class="info-value">${u.pet}</div></div>
                    <div class="section-title">æ·±å…¥éˆé­‚</div>
                    <div class="info-row" style="flex-direction:column;">
                        <div class="info-label" style="width:100%;margin-bottom:5px;">ğŸ’¬ ç ´å†°å›ç­” (${u.ice.split(']')[0].replace('[','')})</div>
                        <div class="info-value" style="background:#FFF3E0; padding:10px; border-radius:10px;">${u.ice.split(']')[1] || u.ice}</div>
                    </div>
                    <div class="info-row"><div class="info-label">ç´„æœƒæœŸå¾…</div><div class="info-value">${u.date}</div></div>
                    <div class="section-title">èˆˆè¶£å–œå¥½</div>
                    <div class="info-row"><div class="info-label">é›»å½±</div><div class="info-value">${u.movie}</div></div>
                    <div class="info-row"><div class="info-label">éŸ³æ¨‚</div><div class="info-value">${u.music}</div></div>
                    <div class="info-row"><div class="info-label">é‹å‹•</div><div class="info-value">${u.sport}</div></div>
                    <div class="info-row"><div class="info-label">å…¶ä»–</div><div class="info-value">${u.hobby}</div></div>
                    <div class="section-title">å€‹æ€§æ¨™ç±¤</div>
                    <div class="tag-display-group">${renderTags(u.tagSocial, 'tag-social')}</div>
                    <div class="tag-display-group">${renderTags(u.tagEmotion, 'tag-emotion')}</div>
                    <div class="tag-display-group">${renderTags(u.tagValue, 'tag-value')}</div>
                    <div class="section-title">å“å‘³èˆ‡é¢¨æ ¼</div>
                    <div class="tag-display-group">${renderTags(u.tagFood, 'tag-food')}</div>
                    <div class="tag-display-group">${renderTags(u.tagStyle, 'tag-style')}</div>
                </div>
                <div class="action-area">
                    <div style="margin-bottom:10px; color:#E64A19; font-weight:bold;">çµ¦æ˜Ÿæ˜Ÿ (è¦ºå¾—æœ‰ç·£åˆ†å—ï¼Ÿ)</div>
                    <div class="star-box">${[1,2,3,4,5].map(i => `<div class="star-btn" onclick="handleRate('${u.name}', ${i})">â­</div>`).join('')}</div>
                    <button class="skip-btn" onclick="handleRate('${u.name}', 0)">ç•¥é</button>
                </div>
            </div>`;
    }

    async function handleRate(toUser, score) {
        const container = document.getElementById('single-card-container');
        container.innerHTML = `<div style="text-align:center; padding:50px; color:#E64A19; font-weight:bold;">å‚³é€ä¸­... â¤ï¸</div>`;
        try { await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "rate", fromUser: localStorage.getItem('yueLaoUser'), toUser, stars: score }) }); } catch(e) {}
        currentIndex++; setTimeout(renderCurrentCard, 500);
    }
</script>
</body>
</html>
