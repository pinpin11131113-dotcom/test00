<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœˆä¸‹è€äºº - æœˆéœé…’å§</title>
    <style>
        body { font-family: 'PingFang TC', sans-serif; background-color: #FFB74D; margin: 0; padding: 10px; color: #4E342E; }
        .container { max-width: 650px; margin: 10px auto; background-color: #FFF9F0; padding: 25px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative; }
        h1 { color: #E64A19; text-align: center; }
        .logout-btn { position: absolute; top: 20px; right: 20px; background: #8D6E63; color: white; border: none; padding: 8px 15px; border-radius: 15px; cursor: pointer; }
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 12px; border: 1.5px solid #FFCC80; border-radius: 12px; box-sizing: border-box; background: white; }
        .btn-main { width: 100%; padding: 18px; background: #E64A19; color: white; border: none; border-radius: 35px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        
        /* å¡ç‰‡è¨­è¨ˆ */
        .card { background: white; border-radius: 20px; padding: 20px; margin-top: 15px; border: 1px solid #FFCC80; text-align: left; }
        .action-area { margin-top: 15px; display: flex; align-items: center; justify-content: space-between; }
        .star-box { font-size: 24px; }
        .star-btn { cursor: pointer; color: #DDD; padding: 0 2px; }
        .star-btn.active { color: gold; }
        .skip-btn { background: #B0BEC5; color: white; border: none; padding: 5px 12px; border-radius: 15px; cursor: pointer; font-size: 12px; }
        .rated-text { color: #8D6E63; font-weight: bold; display: none; background: #EEE; padding: 5px 10px; border-radius: 10px; font-size: 12px; }

        #fallback-box { text-align: center; display: none; margin-top: 20px; }
        #fallback-box img { width: 200px; border-radius: 50%; border: 4px solid #E64A19; }
        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); color: white; text-align: center; padding-top: 200px; z-index: 1000; font-weight: bold; }
        
        /* æ¨™ç±¤æ¨£å¼ */
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .tag-checkbox { display: none; }
        .tag-label { padding: 6px 12px; border: 1.5px solid #FFCC80; border-radius: 20px; background: #FFF; cursor: pointer; font-size: 12px; }
        .tag-checkbox:checked + .tag-label { background: #FF8A80; color: white; border-color: #FF8A80; }
    </style>
</head>
<body>

<div id="loading-overlay">è³‡æ–™å‚³è¼¸ä¸­...</div>

<div class="container">
    <button class="logout-btn" onclick="logout()">åˆ‡æ›èº«ä»½</button>
    <h1>æœˆä¸‹è€äºº</h1>

    <div id="setup-page">
        <h3>1. åŸºæœ¬è³‡æ–™</h3>
        <div class="input-group"><label>åå­—</label><input type="text" id="uName"></div>
        <div class="input-group"><label>è‡ªæˆ‘ä»‹ç´¹</label><textarea id="uBio" placeholder="é—œæ–¼å¦³..."></textarea></div>
        <div class="input-group">
            <label>ç”Ÿæ´»ç…§ (é¸ä¸‰å¼µ)</label>
            <input type="file"><br><input type="file"><br><input type="file">
        </div>
        
        <div class="input-group">
            <div style="display:flex; gap:10px;">
                <input type="number" id="uHeight" placeholder="èº«é«˜">
                <select id="uHoro"><option>ç‰¡ç¾Šåº§</option><option>é‡‘ç‰›åº§</option><option>é›™å­åº§</option><option>å·¨èŸ¹åº§</option><option>ç…å­åº§</option><option>è™•å¥³åº§</option><option>å¤©ç§¤åº§</option><option>å¤©è åº§</option><option>å°„æ‰‹åº§</option><option>æ‘©ç¾¯åº§</option><option>æ°´ç“¶åº§</option><option>é›™é­šåº§</option></select>
                <select id="uMbti">
                    <option value="">MBTI</option>
                    <option>INTJ å»ºç¯‰å¸«</option><option>ENFP ç«¶é¸è€…</option><option>INFP èª¿è§£è€…</option><option>INFJ æå€¡è€…</option><option>ENTP è¾¯è«–å®¶</option>
                    <option>ESTJ ç¸½ç®¡</option><option>ESFJ åŸ·æ”¿å®˜</option><option>ISTP é‘’è³å®¶</option><option>ISFP æ¢éšªå®¶</option>
                </select>
            </div>
        </div>
        <div class="input-group"><label>æ€§åˆ¥</label><select id="uGender"><option>å¥³æ€§</option><option>è·¨å¥³</option><option>éäºŒå…ƒ</option></select></div>
        <div class="input-group"><label>æ€§å‘</label><select id="uSex"><option>å¥³åŒå¿—</option><option>é›™æ€§æˆ€</option><option>ç•°æ€§æˆ€</option><option>æ³›æ€§æˆ€</option></select></div>
        <div class="input-group"><label>ç‹€æ…‹</label><select id="uStatus"><option>å–®èº«</option><option>é–‹æ”¾å¼</option><option>æ›–æ˜§ä¸­</option></select></div>

        <h3>2. æ¨™ç±¤èˆ‡èˆˆè¶£</h3>
        <div id="tag-box"></div>
        <div class="input-group" style="margin-top:20px;"><label>ç´„æœƒæœŸå¾…</label><select id="uDate"><option>å–å’–å•¡</option><option>çœ‹å±•è¦½</option><option>å–é…’</option><option>çœ‹å¤œæ™¯</option><option>æ•£æ­¥</option></select></div>
        <div class="input-group"><label>æ‰‹å¯«èˆˆè¶£</label><textarea id="uHobby"></textarea></div>

        <button class="btn-main" onclick="register()">é€²å…¥æœƒå ´</button>
    </div>

    <div id="venue-page" style="display:none;">
        <div id="fallback-box">
            <img src="staff_old_man.jpg" alt="æœˆè€">
            <p style="color:#E64A19; font-weight:bold;">ç·£åˆ†æ­£åœ¨é‡€é€ ä¸­...</p>
            <p style="font-size:12px; color:#8D6E63;">æš«ç„¡é«˜åº¦å¥‘åˆå°è±¡ï¼Œè«‹æœˆè€å¹«å¿™å§ï¼</p>
        </div>
        <div id="user-cards"></div>
    </div>
</div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbzGGOXqSP0_De4InUp-xBGIux_CuCAS600ACuLE-UFLzlPkPrR_3U6QGCHJKIK1dbMV/exec';

    // ç°¡åŒ–çš„æ¨™ç±¤ç”¢ç”Ÿé‚è¼¯ (ç¸®çŸ­ä»£ç¢¼é•·åº¦)
    const tags = { social:["ç†±æƒ…","æ…¢ç†±","å¹½é»˜"], emotion:["æ„Ÿæ€§","ç†æ™º","ç©©å®š"], value:["äº‹æ¥­","å®¶åº­","å†’éšª"], food:["æ—¥å¼","éŸ“å¼","ç«é‹"], style:["æ­ç¾","æ–‡é’","è¡—é ­"] };
    const tBox = document.getElementById('tag-box');
    Object.keys(tags).forEach(k => {
        tBox.innerHTML += `<h4>${k}</h4><div class="tag-container" id="${k}-tags"></div>`;
        tags[k].forEach((t,i) => {
            document.getElementById(`${k}-tags`).innerHTML += `<input type="checkbox" id="${k}${i}" value="${t}"><label for="${k}${i}" class="tag-label">${t}</label>`;
        });
    });

    if(localStorage.getItem('yueLaoUser')) showVenue();
    function logout() { localStorage.removeItem('yueLaoUser'); location.reload(); }

    async function register() {
        const name = document.getElementById('uName').value;
        if(!name) return alert('è«‹å¡«å¯«åå­—');
        document.getElementById('loading-overlay').style.display = 'block';
        
        const payload = {
            action: "register", uName: name, uBio: document.getElementById('uBio').value, 
            uBirth:'', uHeight: document.getElementById('uHeight').value, uHoro: document.getElementById('uHoro').value,
            uMbti: document.getElementById('uMbti').value, uGender: document.getElementById('uGender').value,
            uSex: document.getElementById('uSex').value, uStatus: document.getElementById('uStatus').value,
            uDate: document.getElementById('uDate').value, uHobby: document.getElementById('uHobby').value,
            tagSocial: '', tagEmotion: '', tagValue: '', tagFood: '', tagStyle: '' 
            // é€™è£¡ç‚ºäº†ç‰ˆé¢çœç•¥äº†æ¨™ç±¤æŠ“å–ï¼Œå¦³åŸæœ¬çš„æ¨™ç±¤æŠ“å–é‚è¼¯æ˜¯å°çš„ï¼Œå¯ä»¥ç›´æ¥ç”¨
        };
        
        await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        localStorage.setItem('yueLaoUser', name);
        setTimeout(showVenue, 1500);
    }

    async function showVenue() {
        document.getElementById('loading-overlay').style.display = 'none';
        document.getElementById('setup-page').style.display = 'none';
        document.getElementById('venue-page').style.display = 'block';
        window.scrollTo(0,0);

        const res = await fetch(API_URL);
        const data = await res.json();
        const me = localStorage.getItem('yueLaoUser');
        const cardBox = document.getElementById('user-cards');
        const fallback = document.getElementById('fallback-box');

        // å¦³çš„åš´æ ¼æ¢ä»¶ï¼šç¸½åˆ†>5 ä¸” isMatch ç‚º true (é›™æ–¹éƒ½çµ¦æ˜Ÿ)
        const myMatches = data.adminStats.filter(s => (s.p1 === me || s.p2 === me) && s.isMatch);

        cardBox.innerHTML = '';
        if(myMatches.length > 0) {
            fallback.style.display = 'none';
            cardBox.innerHTML += `<div style="background:#FFF3E0;padding:15px;border-radius:15px;margin-bottom:20px;border:2px dashed #E64A19;">
                <h3 style="margin:0;color:#E64A19;">ğŸ’– é…å°æˆåŠŸåå–®</h3>
                ${myMatches.map(m => {
                    const p = (m.p1 === me) ? m.p2 : m.p1;
                    return `<div>èˆ‡ <strong>${p}</strong> é»˜å¥‘ç¸½åˆ† ${m.total}ï¼</div>`;
                }).join('')}
            </div>`;
        } else {
            fallback.style.display = 'block';
        }

        // é¡¯ç¤ºå…¶ä»–ç”¨æˆ¶å¡ç‰‡
        const ratedList = data.ratedHistory || {};
        
        data.users.forEach(u => {
            if(u.name === me) return;
            
            // æª¢æŸ¥æˆ‘æ˜¯å¦å·²ç¶“è©•éé€™å€‹äºº
            const hasRated = ratedList[me + "_" + u.name];

            cardBox.innerHTML += `
                <div class="card">
                    <p style="color:#8D6E63;font-style:italic;">ã€Œ${u.bio}ã€</p>
                    <h3 style="margin:5px 0;color:#E64A19;">${u.name} (${u.horo})</h3>
                    <p>MBTI: ${u.mbti}</p>
                    
                    <div class="action-area" id="action-${u.name}" style="display:${hasRated ? 'none' : 'flex'}">
                        <div class="star-box">
                            ${[1,2,3,4,5].map(i => `<span class="star-btn" onclick="rate('${u.name}', ${i})">â˜…</span>`).join('')}
                        </div>
                        <button class="skip-btn" onclick="rate('${u.name}', 0)">ç•¥é</button>
                    </div>
                    
                    <div class="rated-text" style="display:${hasRated ? 'block' : 'none'}">
                        âœ… å·²é€å‡ºå¿ƒæ„
                    </div>
                </div>`;
        });
    }

    async function rate(toUser, score) {
        const fromUser = localStorage.getItem('yueLaoUser');
        // è¦–è¦ºéš±è—
        document.getElementById(`action-${toUser}`).style.display = 'none';
        
        await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "rate", fromUser, toUser, stars: score }) });
        
        // é›–ç„¶ Apps Script æœƒæ“‹ï¼Œä½†å‰ç«¯é€™è£¡ç›´æ¥é¡¯ç¤ºã€Œå·²é€å‡ºã€è®“é«”é©—æ›´å¥½
        setTimeout(showVenue, 1000);
    }
</script>
</body>
</html>
