<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jariah 聯誼報名系統</title>
    <style>
        :root { --main-p: #764ba2; --bg: #f0f2f5; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; justify-content: center; }
        .card { background: white; border-radius: 20px; padding: 25px; width: 100%; max-width: 450px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .section-title { font-size: 15px; font-weight: bold; color: var(--main-p); margin: 20px 0 10px; border-left: 5px solid var(--main-p); padding-left: 10px; }
        .photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .photo-box { aspect-ratio: 1/1; background: #f8f9fa; border-radius: 12px; display: flex; justify-content: center; align-items: center; border: 2px dashed #ddd; cursor: pointer; overflow: hidden; font-size: 24px; color: #ccc; }
        .photo-box img { width: 100%; height: 100%; object-fit: cover; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 12px; margin-bottom: 15px; box-sizing: border-box; }
        .btn-p { background: var(--main-p); color: white; border: none; width: 100%; padding: 16px; border-radius: 15px; font-weight: bold; cursor: pointer; font-size: 16px; }
        .tag-group { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        .tag-btn { background: #eee; padding: 6px 14px; border-radius: 20px; font-size: 12px; cursor: pointer; }
        .tag-btn.active { background: var(--main-p); color: white; }
    </style>
</head>
<body>
<div class="card" id="pe">
    <h2 style="text-align:center;">活動報名</h2>
    <div class="section-title">生活照 (請點擊上傳三張)</div>
    <div class="photo-grid">
        <div class="photo-box" onclick="aid=1;f().click()" id="b-1">+</div>
        <div class="photo-box" onclick="aid=2;f().click()" id="b-2">+</div>
        <div class="photo-box" onclick="aid=3;f().click()" id="b-3">+</div>
    </div>
    <input type="file" id="fi" hidden accept="image/*" onchange="h(event)">
    
    <div class="section-title">資本資料</div>
    <input type="text" id="nn" placeholder="暱稱 (如：冰山)">
    <input type="tel" id="ph" placeholder="手機號碼 (僅供主辦聯繫)">
    <select id="mb"><option>INTP</option><option>ENFP</option><option>INTJ</option><option>INFJ</option></select>
    <input type="text" id="jb" placeholder="目前職業">

    <div class="section-title">生活習慣</div>
    <div class="tag-group" id="ha">
        <span class="tag-btn" onclick="this.classList.toggle('active')">不抽菸</span>
        <span class="tag-btn" onclick="this.classList.toggle('active')">偶爾喝酒</span>
        <span class="tag-btn" onclick="this.classList.toggle('active')">夜貓子</span>
    </div>
    <button class="btn-p" onclick="sv()">儲存並開始配對</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    const cfg = { apiKey: "AIzaSyDv4EOEmJ8dfWgZEv5mYtaiXuzbwgjMAUA", authDomain: "jariah-match.firebaseapp.com", projectId: "jariah-match", storageBucket: "jariah-match.firebasestorage.app", messagingSenderId: "863372390147", appId: "1:863372390147:web:7541b1b478c33f3d824336" };
    const app = initializeApp(cfg); const db = getFirestore(app);
    let aid=1, pts=["","",""], mN="";
    window.f=()=>document.getElementById('fi');
    window.h=(e)=>{
        const file=e.target.files[0];
        if(file){
            const r=new FileReader();
            r.onload=(ev)=>{
                const img=new Image();
                img.onload=()=>{
                    const cvs=document.createElement('canvas');
                    let w=img.width, h=img.height, max=500; // 壓縮至 500px 確保三張圖都能存
                    if(w>h){if(w>max){h*=max/w;w=max;}}else{if(h>max){width*=max/h;h=max;}}
                    cvs.width=w;cvs.height=h;
                    const ctx=cvs.getContext('2d'); ctx.drawImage(img,0,0,w,h);
                    pts[aid-1]=cvs.toDataURL('image/jpeg', 0.6); // 降低品質以節省空間
                    document.getElementById(`b-${aid}`).innerHTML=`<img src="${pts[aid-1]}">`;
                };
                img.src=ev.target.result;
            };
            r.readAsDataURL(file);
        }
    };
    window.sv=async()=>{
        mN=document.getElementById('nn').value; const ph=document.getElementById('ph').value;
        if(!mN || !ph || !pts[0]) return alert("請完整填寫並至少上傳一張封面照");
        try{
            await addDoc(collection(db, "users"), { name:mN, phone:ph, photos:pts, mbti:document.getElementById('mb').value, job:document.getElementById('jb').value, habits:Array.from(document.querySelectorAll('#ha .active')).map(t=>t.innerText), createdAt:serverTimestamp() });
            alert("報名成功！"); location.reload(); // 測試期先重新整理
        } catch(e) { console.error(e); alert("系統忙碌，請嘗試上傳較小的照片"); }
    };
</script>
</body>
</html>
