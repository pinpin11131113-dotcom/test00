
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jariah è¯èª¼é…å°ç³»çµ±</title>
    <style>
        :root { --main-p: #764ba2; --bg: #f0f2f5; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; justify-content: center; }
        .card { background: white; border-radius: 20px; padding: 25px; width: 100%; max-width: 480px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .section-title { font-size: 15px; font-weight: bold; color: var(--main-p); margin: 25px 0 12px; border-left: 5px solid var(--main-p); padding-left: 10px; }
        .hint-text { font-size: 12px; color: #888; margin-bottom: 15px; line-height: 1.5; }
        .tag-group { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .tag-btn { background: #f0f0f0; padding: 6px 14px; border-radius: 20px; font-size: 11px; cursor: pointer; color: #666; transition: 0.2s; }
        .tag-btn.active { background: var(--main-p); color: white; }
        .manual-input { width: 100%; padding: 10px; border: 1px dashed #ccc; border-radius: 10px; font-size: 12px; margin-top: 5px; box-sizing: border-box; outline: none; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 12px; margin-bottom: 12px; box-sizing: border-box; background: #fafafa; }
        textarea { height: 100px; resize: none; }
        .btn-p { background: var(--main-p); color: white; border: none; width: 100%; padding: 16px; border-radius: 15px; font-weight: bold; cursor: pointer; font-size: 16px; }
        .match-status-bar { background: #fff5f6; border: 1px solid #ffccd5; border-radius: 15px; padding: 15px; margin-bottom: 20px; text-align: center; font-weight: bold; }
        .img-scroll { display: flex; gap: 10px; overflow-x: auto; margin-bottom: 15px; padding-bottom: 5px; }
        .img-scroll img { height: 180px; width: 140px; object-fit: cover; border-radius: 15px; flex-shrink: 0; }
        .profile-display { background: #fdfdff; border: 1px solid #eef; border-radius: 15px; padding: 15px; margin-top: 15px; }
        .stars { display: flex; justify-content: center; gap: 12px; font-size: 35px; margin: 15px 0; }
        .star { color: #ddd; cursor: pointer; }
        .star.active { color: #ffa502; }
    </style>
</head>
<body>

<div class="card" id="page-edit" style="display:none;">
    <h2 style="text-align:center;">å»ºç«‹å€‹äººæª”æ¡ˆ</h2>
    <div class="section-title">ç”Ÿæ´»ç…§ (æœ€å¤šä¸‰å¼µ)</div>
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 5px;">
        <div class="photo-box" style="aspect-ratio:1/1; background:#f8f9fa; border-radius:12px; display:flex; justify-content:center; align-items:center; border:2px dashed #ddd; cursor:pointer;" onclick="setPos(1)" id="b-1">+</div>
        <div class="photo-box" style="aspect-ratio:1/1; background:#f8f9fa; border-radius:12px; display:flex; justify-content:center; align-items:center; border:2px dashed #ddd; cursor:pointer;" onclick="setPos(2)" id="b-2">+</div>
        <div class="photo-box" style="aspect-ratio:1/1; background:#f8f9fa; border-radius:12px; display:flex; justify-content:center; align-items:center; border:2px dashed #ddd; cursor:pointer;" onclick="setPos(3)" id="b-3">+</div>
    </div>
    <div class="hint-text">ğŸ’¡ å±•ç¾æœ€çœŸå¯¦çš„å¦³ï¼Œè®“å‘½ä¸­æ³¨å®šçš„å°è±¡èƒ½ä¸€çœ¼èªå‡ºå¦³å–”ã€‚</div>
    <input type="file" id="fi" hidden accept="image/*" onchange="handleFile(event)">

    <div class="section-title">åŸºæœ¬è³‡æ–™</div>
    <input type="text" id="nn" placeholder="æš±ç¨±">
    <input type="tel" id="ph" placeholder="æ‰‹æ©Ÿè™Ÿç¢¼ (åƒ…ä¾›è¯ç¹«ç”¨)">
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <input type="text" id="bd" placeholder="ç”Ÿæ—¥ (MM/DD)">
        <select id="sx"><option value="">æ˜Ÿç›¤/ç´«å¾®</option><option>é›™é­šåº§</option><option>è™•å¥³åº§</option><option>å¤©è åº§</option></select>
    </div>
    <textarea id="bi" placeholder="å€‹äººç°¡ä»‹... (ä¾‹å¦‚ï¼šé¤Šäº†ä¸€éš»è²“å’Œä¸€éš»å…”å­çš„ç‹—æ´¾)"></textarea>

    <div class="section-title">ç¤¾äº¤èˆ‡äº’å‹•é¢¨æ ¼ (15é …)</div>
    <div class="tag-group" id="s-tags"></div>
    <input type="text" id="s-extra" class="manual-input" placeholder="+ æ‰‹å‹•è£œå……æ‚¨çš„ç¤¾äº¤é¢¨æ ¼">

    <div class="section-title">æƒ…ç·’èˆ‡æ„Ÿå—æ–¹å¼ (15é …)</div>
    <div class="tag-group" id="e-tags"></div>
    <input type="text" id="e-extra" class="manual-input" placeholder="+ æ‰‹å‹•è£œå……æ‚¨çš„æƒ…ç·’ç‰¹è³ª">

    <div class="section-title">ç”Ÿæ´»æ…‹åº¦èˆ‡åƒ¹å€¼è§€ (15é …)</div>
    <div class="tag-group" id="v-tags"></div>
    <input type="text" id="v-extra" class="manual-input" placeholder="+ æ‰‹å‹•è£œå……æ‚¨çš„åƒ¹å€¼è§€">

    <div class="section-title">æ„Ÿæƒ…èªåŒ</div>
    <select id="orient"><option value="">æ€§å–å‘</option><option>å¥³åŒå¿—</option><option>é›™æ€§æˆ€</option><option>æ³›æ€§æˆ€</option><option>é…·å…’</option><option>No Label</option></select>
    <select id="ident"><option value="">è‡ªæˆ‘èªåŒ</option><option>Lesbian</option><option>æ€§åˆ¥é…·å…’</option><option>No Label / ä¸æƒ³æ¨™ç±¤</option><option>å…¶ä»–</option></select>
    <select id="stat"><option value="">æ„Ÿæƒ…ç‹€æ…‹</option><option>å–®èº«</option><option>é–‹æ”¾å¼é—œä¿‚</option><option>æ›–æ˜§ä¸­</option><option>å°‹æ‰¾ç©©å®šé—œä¿‚</option></select>

    <button class="btn-p" onclick="saveData()">é€²å…¥æœƒå ´</button>
</div>

<div class="card" id="page-discovery" style="display:none;">
    <div class="match-status-bar" id="match-status-ui">è®€å–ç·£åˆ†ä¸­...</div>
    <img id="old-man-img" src="staff_old_man.jpg" style="width:100%; border-radius:15px; display:none; margin-bottom:20px;">
    
    <div id="success-match-area" style="display:none; margin-bottom:20px;">
        <div style="color:var(--main-p); font-size:13px; font-weight:bold; margin-bottom:10px;">ğŸŒŸ äº’æœ‰å¥½æ„Ÿçš„å°è±¡ (æœ€å¤š3ä½)ï¼š</div>
        <div id="match-list"></div>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h2>æ¢ç´¢å°è±¡</h2>
        <button onclick="location.reload()" style="font-size:11px; padding:5px; background:#eee; border:none; border-radius:5px;">æ›´æ–°åå–®</button>
    </div>
    
    <div id="target-photos" class="img-scroll"></div>
    <div class="profile-display">
        <div id="target-name" style="font-size:22px; font-weight:bold; margin-bottom:5px;"></div>
        <div id="target-identity" style="font-size:12px; color:#888; margin-bottom:10px;"></div>
        <div id="target-bio" style="font-size:14px; line-height:1.6; white-space:pre-wrap; background:#fff; padding:10px; border-radius:10px; border:1px solid #f0f0f0;"></div>
        <div id="target-tags" class="tag-group" style="margin-top:15px;"></div>
    </div>

    <div class="stars"><span class="star" data-v="1">â˜…</span><span class="star" data-v="2">â˜…</span><span class="star" data-v="3">â˜…</span><span class="star" data-v="4">â˜…</span><span class="star" data-v="5">â˜…</span></div>
    <button class="btn-p" onclick="submitRating()">é€å‡ºè©•åˆ†</button>
    <button onclick="logout()" style="width:100%; background:none; border:none; color:#bbb; font-size:12px; margin-top:20px; text-decoration:underline; cursor:pointer;">ä¿®æ”¹å ±åè³‡æ–™</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const cfg = { apiKey: "AIzaSyDv4EOEmJ8dfWgZEv5mYtaiXuzbwgjMAUA", authDomain: "jariah-match.firebaseapp.com", projectId: "jariah-match", storageBucket: "jariah-match.firebasestorage.app", messagingSenderId: "863372390147", appId: "1:863372390147:web:7541b1b478c33f3d824336" };
    const app = initializeApp(cfg); const db = getFirestore(app);

    // 15å€‹é¸é …é…ç½®
    const sOpts = ["å¹³æ˜“è¿‘äºº", "ç›´ä¾†ç›´å¾€", "æ…¢ç†±å…§æ–‚", "ç†±æƒ…å¥”æ”¾", "å¹½é»˜é¢¨è¶£", "æ“…é•·å‚¾è½", "è§€å¯Ÿæ•éŠ³", "ä¸»å°æ€§å¼·", "éš¨å’Œé«”è²¼", "ç¤¾äº¤é”äºº", "å–œæ­¡ç¨è™•", "èª å¯¦çœŸæ‘¯", "åœ“æ»‘å‘¨åˆ°", "å……æ»¿å¥½å¥‡", "æ°£å ´å¼·å¤§"];
    const eOpts = ["ç†æ€§å†·éœ", "æ„Ÿæ€§ç´°è†©", "æƒ…ç·’ç©©å®š", "ç›´è¦ºæ•éŠ³", "æ¨‚è§€ç©æ¥µ", "æº«æŸ”é«”è²¼", "è‡ªæˆ‘å¯Ÿè¦ºé«˜", "å…±æƒ…åŠ›å¼·", "å®¹æ˜“ç„¦æ…®", "éš¨é‡è€Œå®‰", "å…§å¿ƒæˆ²å¤š", "å‰›æ¯…å …å¼·", "ç†±æ„›æ€è€ƒ", "æƒ…æ„Ÿè±å¯Œ", "å®¹æ˜“æ„Ÿå‹•"];
    const vOpts = ["äº«å—ç”Ÿæ´»", "ç›®æ¨™å°å‘", "å¹³å‡¡æ˜¯ç¦", "å†’éšªç²¾ç¥", "å´‡å°šè‡ªç”±", "é‡è¦–å¥åº·", "æŒçºŒå­¸ç¿’", "æ´»åœ¨ç•¶ä¸‹", "ä½”æœ‰æ…¾å¼·", "è‡ªå¾‹åš´è¬¹", "è¿½æ±‚å“è¶Š", "æ¥µç°¡ä¸»ç¾©", "é‡è¦–å®¶åº­", "æµªæ¼«ä¸»ç¾©", "å¯¦è¸ä¸»ç¾©"];

    let curId = 1, pts = ["", "", ""], myName = "", users = [], curIdx = 0, myRate = 0;

    window.onload = () => {
        const render = (id, opts) => { document.getElementById(id).innerHTML = opts.map(o => `<span class="tag-btn" onclick="this.classList.toggle('active')">${o}</span>`).join(''); };
        render('s-tags', sOpts); render('e-tags', eOpts); render('v-tags', vOpts);
        
        const urlP = new URLSearchParams(window.location.search);
        if(urlP.get('u')) { localStorage.setItem('jariah_user', urlP.get('u')); window.history.replaceState({}, '', 'index.html'); }
        const saved = localStorage.getItem('jariah_user');
        if (saved) { myName = saved; document.getElementById('page-discovery').style.display = 'block'; fetchUsers(); checkMatchStatus(); setupTester(); }
        else { document.getElementById('page-edit').style.display = 'block'; }
    };

    window.setPos = (id) => { curId = id; document.getElementById('fi').click(); };
    window.handleFile = (e) => {
        const file = e.target.files[0];
        if (file) {
            const r = new FileReader();
            r.onload = (ev) => {
                const img = new Image();
                img.onload = () => {
                    const cvs = document.createElement('canvas'); let w = img.width, h = img.height, max = 500;
                    if (w > h) { if (w > max) { h *= max / w; w = max; } } else { if (h > max) { w *= max / h; h = max; } }
                    cvs.width = w; cvs.height = h; const ctx = cvs.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
                    pts[curId - 1] = cvs.toDataURL('image/jpeg', 0.5); document.getElementById(`b-${curId}`).innerHTML = `<img src="${pts[curId - 1]}" style="width:100%;height:100%;object-fit:cover;">`;
                };
                img.src = ev.target.result;
            };
            r.readAsDataURL(file);
        }
    };

    window.saveData = async () => {
        const n = document.getElementById('nn').value; const p = document.getElementById('ph').value;
        if(!n || !p || !pts[0]) return alert("è«‹å¡«å¯«å¿…å¡«é …ä¸¦å‚³ç…§ç‰‡");
        const getTs = (id, exId) => { let ts = Array.from(document.querySelectorAll(`#${id} .active`)).map(t=>t.innerText); if(document.getElementById(exId).value) ts.push(document.getElementById(exId).value); return ts; };
        try {
            await addDoc(collection(db, "users"), {
                name: n, phone: p, bio: document.getElementById('bi').value,
                sTs: getTs('s-tags', 's-extra'), eTs: getTs('e-tags', 'e-extra'), vTs: getTs('v-tags', 'v-extra'),
                orient: document.getElementById('orient').value, ident: document.getElementById('ident').value, stat: document.getElementById('stat').value,
                photos: pts, createdAt: serverTimestamp()
            });
            localStorage.setItem('jariah_user', n); location.reload();
        } catch(e) { alert("å„²å­˜å¤±æ•—"); }
    };

    async function fetchUsers() {
        const snap = await getDocs(query(collection(db, "users"), orderBy("createdAt", "desc")));
        users = []; snap.forEach(doc => { if(doc.data().name !== myName) users.push(doc.data()); });
        showUser();
    }

    function showUser() {
        if(curIdx >= users.length) { document.getElementById('target-name').innerText = "æš«æ™‚æ²’äººå›‰"; document.getElementById('target-photos').innerHTML = ""; return; }
        const u = users[curIdx];
        document.getElementById('target-name').innerText = u.name;
        document.getElementById('target-photos').innerHTML = u.photos.filter(p=>p).map(p=>`<img src="${p}">`).join('');
        document.getElementById('target-identity').innerText = `${u.orient||''} | ${u.ident||''} | ${u.stat||''}`;
        document.getElementById('target-bio').innerText = u.bio || "é€™å€‹äººå¾ˆç¥ç¥•ï¼Œä»€éº¼éƒ½æ²’å¯«...";
        const all = [...(u.sTs||[]), ...(u.eTs||[]), ...(u.vTs||[])];
        document.getElementById('target-tags').innerHTML = all.map(t => `<span class="tag-btn" style="cursor:default;">#${t}</span>`).join('');
        resetStars();
    }

    const stars = document.querySelectorAll('.star');
    stars.forEach(s => s.onclick = () => { myRate = parseInt(s.dataset.v); stars.forEach(st => st.classList.toggle('active', st.dataset.v <= myRate)); });
    function resetStars() { myRate = 0; stars.forEach(st => st.classList.remove('active')); }

    window.submitRating = async () => {
        if(myRate === 0) return alert("è«‹è©•åˆ†");
        if(myRate >= 4) { await addDoc(collection(db, "matches"), { pair: [myName, users[curIdx].name], score: myRate, time: serverTimestamp() }); }
        alert("è©•åˆ†æˆåŠŸï¼"); curIdx++; showUser(); checkMatchStatus();
    };

    async function checkMatchStatus() {
        const snap = await getDocs(query(collection(db, "matches"), where("pair", "array-contains", myName)));
        let pairs = {}; snap.forEach(doc => { const d = doc.data(); let other = d.pair.find(n => n !== myName); if (!pairs[other]) pairs[other] = { score: 0, count: 0 }; pairs[other].score += d.score; pairs[other].count += 1; });
        let finalM = Object.keys(pairs).filter(k => pairs[k].count === 2 && pairs[k].score >= 5).sort((a,b) => pairs[b].score - pairs[a].score).slice(0, 3);
        const sUI = document.getElementById('match-status-ui'); const old = document.getElementById('old-man-img'); const mA = document.getElementById('success-match-area');
        if (finalM.length > 0) {
            sUI.innerHTML = `ğŸ’– æ­å–œï¼æœ‰ ${finalM.length} ä½èˆ‡å¦³äº’æœ‰å¥½æ„Ÿ`; old.style.display = 'none'; mA.style.display = 'block';
            document.getElementById('match-list').innerHTML = finalM.map(m => `<div style="background:#fff;border:1px solid #eee;padding:12px;border-radius:12px;display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;"><b>${m}</b><span style="font-size:11px; color:#27ae60;">âœ¨ å°±åœ¨ç¾å ´ï¼Œå¿«å»æ‰¾å¥¹å§ï¼</span></div>`).join('');
        } else { sUI.innerText = "âœ¨ è½‰å€Ÿæœˆä¸‹è€äººï¼Œç·£åˆ†å°±åœ¨ä¸é è™•"; old.style.display = 'block'; mA.style.display = 'none'; }
    }
    window.logout = () => { localStorage.removeItem('jariah_user'); location.reload(); };
    async function setupTester() {
        const snap = await getDocs(collection(db, "users"));
        let h = `<div style="position:fixed; bottom:5px; right:5px; background:rgba(0,0,0,0.5); padding:5px; border-radius:5px; z-index:999;"><select onchange="if(this.value){localStorage.setItem('jariah_user', this.value); location.reload();}" style="font-size:10px;"><option value="">å¿«é€Ÿåˆ‡æ›èº«åˆ†</option>`;
        snap.forEach(d => { h += `<option value="${d.data().name}">${d.data().name}</option>`; });
        document.body.insertAdjacentHTML('beforeend', h + `</select></div>`);
    }
</script>
</body>
</html>
